(window.webpackJsonp=window.webpackJsonp||[]).push([[63],{404:function(t,e,a){"use strict";a.r(e);var s=a(25),n=function(t){t.options.__data__block__={mermaid_64a560ae:'graph TD\n\nui[WUI to CRUD Sources]\nrunui[Run UI]\nconfig(Harvest Source API)\nmetastore(MetaStore API for<br /> harvested metadata)\nlogging(Reporting API)\nrunner[Runner + Queue - Airflow]\nrunapi[Run API - Logic of Running Jobs etc]\npipeline[Pipeline System + Library]\n\nsubgraph "CKAN Classic"\n  ui --\x3e config\n  metastore\nend\n\nsubgraph "Next Gen Components"\n  runui --\x3e runapi\n  runapi --\x3e runner\n  pipeline\nend\n\npipeline --\x3e metastore\nconfig -.-> runapi\nrunner --\x3e pipeline\npipeline -.reporting/errors.-> logging\n\nsubgraph "Pipeline System + Library"\n  framework[Framework<br/>DataFlows + Data Packages] --\x3e dataerror[Data Errors]\n  dataerror --\x3e ckansync[CKAN Syncing]\n  ckansync --\x3e datajson[data.json impl]\nend\n\nclassDef done fill:lightgreen,stroke:#333,stroke-width:2px;\nclassDef existsneedsmod fill:blue,stroke:#333,stroke-width:2px;\nclassDef started fill:yellow,stroke:#333,stroke-width:2px;\nclassDef todo fill:orange,stroke:#333,stroke-width:2px;\n\nclass config,metastore,runner,ui,datajson,ckansync,framework,pipeline done;\nclass runapi started;\nclass runui,logging todo;\n',mermaid_64a55998:'graph LR\n\nsubgraph "Extract and Transform"\n  extract[Extract] --\x3e transform[Transform]\nend\n\nsubgraph "Load"\n  transform --data package--\x3e load[Load]\nend\n\nload --\x3e ckan((CKAN))\n',mermaid_64a55824:"graph TD\n\nget[Retrieve data.json]\nvalidate[Validate data.json]\nsplit[Split data.json into datasets]\ndatapkg[Convert each data.json dataset into Data Package]\nwrite[Write results somewhere local]\nckan[Sync to CKAN - work out diff and implement]\n\nget --\x3e validate\nvalidate --\x3e split\nsplit --\x3e datapkg\ndatapkg --\x3e write\nwrite --\x3e ckan\n",mermaid_64a552dc:'graph TD\n\ndownload[Download data]\nfetch[Fetch]\nvalidate[Validate data]\nget_previous_datasets(Get previous harvested data)\nsave_download_results(Save as Data Package)\ncompare(Compare)\nsave_compare_results(Save compare results)\nwrite_destination(Write to destination)\nsave_previous_data(Save as Data Package)\nsave_log_report(Save final JSON log)\nfederal[Federal]\nnon_federal[Non Federal]\ndataset_adapter[Dataset Adapter]\nresource_adapter[Resource Adapter]\n\nclassDef green fill:lightgreen;\nclass download,fetch,validate,get_previous_datasets,save_download_results,compare,save_compare_results,write_destination,save_previous_data,save_log_report,federal,non_federal,dataset_adapter,resource_adapter green;\n\nsubgraph "Harvest source derivated (data.json, WAF, CSW)"\n  download\n  save_download_results\nend\n\nsubgraph "Harvester core"\n  fetch\n  subgraph Validators\n    validate\n    federal\n    non_federal\n  end\n  subgraph Adapters\n    dataset_adapter\n    resource_adapter\n  end\nend\n\nsubgraph "Harvest Source base class"\n  save_download_results\n  compare\n  save_compare_results\n  save_log_report\nend\n\nsubgraph "Harvest Destination"\n  get_previous_datasets\n  write_destination\n  save_previous_data\nend\n\ndownload -.transform to general format.-> save_download_results\nsave_download_results --\x3e compare\ncompare --\x3e save_compare_results\nsave_compare_results --\x3e dataset_adapter\ndataset_adapter --\x3e resource_adapter\nresource_adapter --\x3e write_destination\n\nget_previous_datasets -.transform to general format.-> save_previous_data\nsave_previous_data --\x3e compare\n\ncompare -.Logs.-> save_log_report\ndownload --\x3e fetch\nfetch --\x3e validate\nvalidate --\x3e download\n',mermaid_64a54b54:'graph LR\n\nconfig[Configuration]\netl[ETL - ckanext-harvesting etc]\nckan[CKAN Classic]\nnew["New ETL System"]\n\nsubgraph "Current CKAN Classic"\n  config\n  etl\nend\n\nsubgraph Future\n  ckan\n  new\nend\n\nconfig --\x3e ckan\netl --\x3e new\n',mermaid_64a54b22:'graph TD\n\nconfig[Configuration e.g. Harvest sources]\napi[Web API - for config, status updates etc]\nui[User Interface to create harvests, see results]\nmetastore["Storage for the harvested metadata (+ data)"]\nlogging[Logging]\n\nsubgraph "CKAN Classic"\n  config\n  ui\n  metastore\n  api\n  logging\nend\n\nsubgraph ETL\n  runner[Runner + Queue]\n  pipeline[Pipeline system]\nend\n\n\npipeline --\x3e metastore\nconfig --\x3e runner\nrunner --\x3e pipeline\npipeline -.reporting/errors.-> logging\nui --\x3e config\nlogging --\x3e api\nmetastore --\x3e api\nconfig --\x3e api\n',mermaid_64a53c0e:"graph TD\n\ngather[Gather]\n\nrun[harvest run] --generates a HarvestJob--\x3e gather\ngather --generates HarvestObject for each remote source item --\x3e fetch\nfetch --HarvestObject updated with remote metadata--\x3e import\nimport --store package--\x3e ckan[CKAN Package]\nimport --HarvestObject updated --\x3e harvestdb[Harvest DB]\n"}},r=Object(s.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"harvesting"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#harvesting"}},[t._v("#")]),t._v(" Harvesting")]),t._v(" "),a("h2",{attrs:{id:"introduction"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#introduction"}},[t._v("#")]),t._v(" Introduction")]),t._v(" "),a("p",[t._v("Harvesting is the automated collection into a Data Portal of metadata (and maybe data) from other catalogs and sources.")]),t._v(" "),a("p",[t._v("The core epic is: As a Data Portal Manager I want to harvest datasets’ metadata (and maybe data) from other portals into my portal so that all the metadata is in one place and hence searchable/discoverable there")]),t._v(" "),a("h3",{attrs:{id:"features"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#features"}},[t._v("#")]),t._v(" Features")]),t._v(" "),a("p",[t._v("Key features include:")]),t._v(" "),a("ul",[a("li",[t._v("Harvest from multiple sources and with a variety of source metadata formats (e.g. data.json, DCAT, CKAN etc).\n"),a("ul",[a("li",[t._v("Implied is the ability to create and maintain (generic) harvesters for different types of metadata (e.g. data.json, DCAT) (below we call these pipelines)")]),t._v(" "),a("li",[t._v("Off-the-shelf harvesting for common metadata formats e.g. data.json, DCAT etc")])])]),t._v(" "),a("li",[t._v("Incremental, efficient harvesting from a given source. For example, imagine a source catalog that has ~100k datasets and adds 100 new datasets every day. Assuming you have already harvested this catalog, you only want to harvest those 100 new datasets during your daily harvest (and not re-harvest all 100k). Similarly, you want to be able to handle deletions and modifications of existing datasets.\n"),a("ul",[a("li",[t._v("And even more complex case is where the harvested metadata is edited in the harvesting catalog and one has to handle merging of changes from the source catalog into the harvesting catalog (i.e. you can handle changes in both locations).")])])]),t._v(" "),a("li",[t._v("Create and update harvest sources via API and UI")]),t._v(" "),a("li",[t._v("Run and view harvests via API (and UI) and the background logging and monitoring to support that")]),t._v(" "),a("li",[t._v("Detailed and useful feedback of harvesting errors so that harvest maintainers (or downstream catalog maintainers) can quickly and easily diagnose and fix issues")]),t._v(" "),a("li",[t._v("Robust and reliable performance, for example supporting harvesting thousands or even millions of datasets a day")])]),t._v(" "),a("h3",{attrs:{id:"harvesting-is-etl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#harvesting-is-etl"}},[t._v("#")]),t._v(" Harvesting is ETL")]),t._v(" "),a("p",[t._v("“Harvesting” of metadata in its essence is exactly the same as any data collection and transformation process (“ETL”). “Metadata” is no different from any other data for our purposes (it is just quite small!).")]),t._v(" "),a("p",[t._v("This insight allows us to see harvesting as just like any other ETL process. At the same time, the specific nature of "),a("em",[t._v("this")]),t._v(" ETL process e.g. that it is about collecting dataset metadata, allows us to design the system in specific ways.")]),t._v(" "),a("p",[t._v("We can use standard ETL tools to do harvesting, loosely coupling their operation to the CKAN Classic (or CKAN Next Gen) metastore.")]),t._v(" "),a("h3",{attrs:{id:"domain-model"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#domain-model"}},[t._v("#")]),t._v(" Domain Model")]),t._v(" "),a("p",[t._v("The Harvesting Domain Model has the following conceptual components:")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("Pipeline")]),t._v(": a generic “harvester” pipeline for harvesting a particular data type e.g. data.json, dcat. A pipeline consists of Processors.")]),t._v(" "),a("li",[a("strong",[t._v("Source (aka Harvester)")]),t._v(": the entire spec of a repeatable harvest from a given source including the pipeline to use, the source info and any additional configuration e.g. the schedule on which to run this")]),t._v(" "),a("li",[a("strong",[t._v("Run (Job)")]),t._v(": a given run of a Source")]),t._v(" "),a("li",[a("strong",[t._v("Dataset")]),t._v(": a resulting dataset.")]),t._v(" "),a("li",[a("strong",[t._v("Log (Entry)")]),t._v(": (including errors)")])]),t._v(" "),a("p",[t._v("NB: the term harvester is often used both for a pipeline (e.g. the DCAT Harvester) and for a Source e.g. “XYZ Agency data.json Harvester”. Because of this confusion we prefer to avoid the term, or to reserve it for an active Source e.g. “the GSA data.json harvester”.")]),t._v(" "),a("h3",{attrs:{id:"components"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#components"}},[t._v("#")]),t._v(" Components")]),t._v(" "),a("p",[t._v("A Harvesting system has the following key subsystems and components:")]),t._v(" "),a("h4",{attrs:{id:"etl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#etl"}},[t._v("#")]),t._v(" ETL")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("Pipelines")]),t._v(": a standard way of creating pipelines and processors in code")]),t._v(" "),a("li",[a("strong",[t._v("Runner")]),t._v(": a system for executing Runs of the harvesters. This should be queue based.")]),t._v(" "),a("li",[a("strong",[t._v("Logging")]),t._v(": a system for logging (and reporting) including of errors")]),t._v(" "),a("li",[a("strong",[t._v("Scratch (Store)")]),t._v(": Intermediate storage for temporary or partial outputs of the")]),t._v(" "),a("li",[a("strong",[t._v("API")]),t._v(": interfaces the runner and errors")])]),t._v(" "),a("h4",{attrs:{id:"sources-and-configuration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sources-and-configuration"}},[t._v("#")]),t._v(" Sources and Configuration")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("Source Store")]),t._v(": database of Sources")]),t._v(" "),a("li",[a("strong",[t._v("API/UI")]),t._v(": UI, API and CLI usually covering Source Store plus reporting on them e.g. Runs, Errors etc")])]),t._v(" "),a("h4",{attrs:{id:"ui-web-command-line-etc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ui-web-command-line-etc"}},[t._v("#")]),t._v(" UI (web, command line etc)")]),t._v(" "),a("ul",[a("li",[t._v("User interface (web and/or command line etc) to ETL e.g. runner, errors")]),t._v(" "),a("li",[t._v("User interface to sources and configuration")])]),t._v(" "),a("h4",{attrs:{id:"metastore"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#metastore"}},[t._v("#")]),t._v(" MetaStore")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("MetaStore")]),t._v(": the store for harvested metadata – this is considered to be outside the harvesting system itself")])]),t._v(" "),a("h2",{attrs:{id:"ckan-v2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ckan-v2"}},[t._v("#")]),t._v(" CKAN v2")]),t._v(" "),a("p",[t._v("CKAN v2 implements harvesting via "),a("a",{attrs:{href:"https://github.com/ckan/ckanext-harvest",target:"_blank",rel:"noopener noreferrer"}},[t._v("ckanext-harvest extension"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("This extension stores configuration in the main DB and harvesters run off a queue process. A detailed analysis of how it works is in "),a("a",{attrs:{href:"#appendix-ckan-classic-harvesting-in-detail"}},[t._v("the appendix below")]),t._v(".")]),t._v(" "),a("h3",{attrs:{id:"limitations"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#limitations"}},[t._v("#")]),t._v(" Limitations")]),t._v(" "),a("p",[t._v("The main problem is that ckanext-harvest builds its own bespoke mini-ETL system and builds this into CKAN. A bespoke system is less powerful and flexible, harder to maintain etc and building it in makes CKAN more bulky (conceptually, resource wise etc) and creates unnecessary coupling.")]),t._v(" "),a("p",[t._v("Good: Using CKAN as config store and having a UI for that")]),t._v(" "),a("p",[t._v("Not so good:")]),t._v(" "),a("ul",[a("li",[t._v("An ETL system integrated with CKAN\n"),a("ul",[a("li",[t._v("Tightly coupled: so running tests of ETL requires CKAN. This makes it harder to creaate tests (with the result that many harvests have few or no tests).")]),t._v(" "),a("li",[t._v("Installation is painful (CKAN + 6 steps) making it harder to use, maintain and contribute to")]),t._v(" "),a("li",[t._v("Dependent on CKAN upgrade cycles (tied via code rather than service API)")]),t._v(" "),a("li",[t._v("CKAN is more complex")])])]),t._v(" "),a("li",[t._v("Bespoke ETL system is both less powerful and harder to maintain\n"),a("ul",[a("li",[t._v("For example, the Runner is bespoke to CKAN rather than using something standard like e.g. Airflow")]),t._v(" "),a("li",[t._v("Rigid structure (gather, fetch, import) which may not fit many situations e.g. data.json harvesting (one big file with many datasets where everything done in gather) or where dependencies between stages")])])]),t._v(" "),a("li",[t._v("Logging and reporting is not great and hard to customize (logs into CKAN)")]),t._v(" "),a("li",[t._v("Maintenance Status - Some maintenance but not super it looks like but quite a lot outstanding (as of Aug 2019):\n"),a("ul",[a("li",[t._v("47 "),a("a",{attrs:{href:"https://github.com/ckan/ckanext-harvest/issues",target:"_blank",rel:"noopener noreferrer"}},[t._v("open issues"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("6 "),a("a",{attrs:{href:"https://github.com/ckan/ckanext-harvest/pulls",target:"_blank",rel:"noopener noreferrer"}},[t._v("open pull requests"),a("OutboundLink")],1),t._v(" (some over a year old)")])])])]),t._v(" "),a("h2",{attrs:{id:"ckan-v3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ckan-v3"}},[t._v("#")]),t._v(" CKAN v3")]),t._v(" "),a("p",[t._v("Next Gen harvesting decouples the core “ETL” part of harvesting into a small, self-contained microservice that is runnable on its own and communicates with the rest of CKAN over APIs. This is consistent with the general "),a("RouterLink",{attrs:{to:"/next-gen/"}},[t._v("next gen microservice approach")]),t._v(".")],1),t._v(" "),a("p",[t._v("The design allows the Next Gen Harvester to be used with both CKAN Classic and CKAN Next Gen.")]),t._v(" "),a("p",[t._v("Perhaps most important of all, the core harvester can use standard third-party patterns and tools to make it both more powerful, easier to maintain and easier to use. For example, it can use Airflow for its runner rather than a bespoke system built into CKAN.")]),t._v(" "),a("h3",{attrs:{id:"features-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#features-2"}},[t._v("#")]),t._v(" Features")]),t._v(" "),a("p",[t._v("Specific aspects of the next gen approach:")]),t._v(" "),a("ul",[a("li",[t._v("Simple: Easy to write harvesters – just a python script and you can create harvesters without needing to know almost anything about CKAN")]),t._v(" "),a("li",[t._v("Runnable and testable standalone (without the rest of CKAN) which makes running and testing much easier")]),t._v(" "),a("li",[t._v("Uses the latest standard ETL techniques and technologies")]),t._v(" "),a("li",[t._v("Multi-cluster support: run one harvester for multiple CKAN instances")]),t._v(" "),a("li",[t._v("Data Package based")])]),t._v(" "),a("h3",{attrs:{id:"design"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#design"}},[t._v("#")]),t._v(" Design")]),t._v(" "),a("p",[t._v("Here is an overview of the design. Further details on specific parts e.g. Pipelines in following sections. Coloring indicates implementation status:")]),t._v(" "),a("ul",[a("li",[t._v("Green: Implemented")]),t._v(" "),a("li",[t._v("Pink: In progress")]),t._v(" "),a("li",[t._v("Grey: Next up")])]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_64a560ae",graph:t.$dataBlock.mermaid_64a560ae}}),a("h3",{attrs:{id:"user-journey"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#user-journey"}},[t._v("#")]),t._v(" User Journey")]),t._v(" "),a("ul",[a("li",[t._v("Harvest Curator goes to WUI for Sources and does Create Harvest Source …")]),t._v(" "),a("li",[t._v("Fills it in …")]),t._v(" "),a("li",[t._v("Comes back to the harvest source dashboard")]),t._v(" "),a("li",[t._v("To run a harvest source you go to the new Run UI interface\n"),a("ul",[a("li",[t._v("It lists all harvest sources like the harvest source …")])])]),t._v(" "),a("li",[t._v("Click on Run (even if this is just to set up the schedule …)")]),t._v(" "),a("li",[t._v("Go to Job page for this run which shows the status of this run and any results …")]),t._v(" "),a("li",[t._v("[TODO: how do we link up harvest sources to runs]")])]),t._v(" "),a("h3",{attrs:{id:"pipelines"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pipelines"}},[t._v("#")]),t._v(" Pipelines")]),t._v(" "),a("p",[t._v("These follow a standard pattern:")]),t._v(" "),a("ul",[a("li",[t._v("Built in Python")]),t._v(" "),a("li",[t._v("Use DataFlows by default as way to structure the pipeline (but you can use anything)")]),t._v(" "),a("li",[t._v("Produce data packages at each step")]),t._v(" "),a("li",[t._v("Pipelines should be divided into two parts:\n"),a("ul",[a("li",[t._v("Extract and Transform: (fetch and convert) fetching remote datasets and converting them into a standard intermediate form (Data Packages)")]),t._v(" "),a("li",[t._v("Load: loading that intermediate form into the CKAN instance. This includes not only the format conversion but the work to synchronize state i.e. to create, update or delete in CKAN based on whether a given dataset from the source already has a representation in CKAN (harvests run repeatedly).")])])])]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_64a55998",graph:t.$dataBlock.mermaid_64a55998}}),a("p",[t._v("This pattern has these benefits:")]),t._v(" "),a("ul",[a("li",[t._v("Load functionality to be reused across Harvest Pipelines (the same Load functionality can be used again and again)")]),t._v(" "),a("li",[t._v("Cleaner testing: you can test extract and load without needing to have a CKAN instance")]),t._v(" "),a("li",[t._v("Ability to reuse Data Package tooling")])]),t._v(" "),a("h4",{attrs:{id:"pipeline-example-fetch-and-process-a-data-json"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pipeline-example-fetch-and-process-a-data-json"}},[t._v("#")]),t._v(" Pipeline Example: Fetch and process a data.json")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("Extract")]),t._v(": Take say a data.json\n"),a("ul",[a("li",[t._v("Validate")])])]),t._v(" "),a("li",[a("strong",[t._v("Transform")]),t._v(": Split into datasets and then transform into data packages\n"),a("ul",[a("li",[t._v("Save to local")])])]),t._v(" "),a("li",[a("strong",[t._v("Transform 2")]),t._v(" check the difference and write to the existing DB.")]),t._v(" "),a("li",[a("strong",[t._v("Load")]),t._v(": Write to DB (CKAN metastore / DB)")])]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_64a55824",graph:t.$dataBlock.mermaid_64a55824}}),a("h4",{attrs:{id:"pipeline-example-detailed"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pipeline-example-detailed"}},[t._v("#")]),t._v(" Pipeline example detailed")]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_64a552dc",graph:t.$dataBlock.mermaid_64a552dc}}),a("h3",{attrs:{id:"runner"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#runner"}},[t._v("#")]),t._v(" Runner")]),t._v(" "),a("p",[t._v("We use Apache Airflow for the Runner.")]),t._v(" "),a("h3",{attrs:{id:"source-spec"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#source-spec"}},[t._v("#")]),t._v(" Source Spec")]),t._v(" "),a("p",[t._v("This the specification of the Source object")]),t._v(" "),a("p",[t._v("You can compare this to "),a("a",{attrs:{href:"#harvest-source-objects"}},[t._v("CKAN Classic HarvestSource objects below")]),t._v(".")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\nurl"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\ntitle"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\ndescription"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\ncreated"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\nharvester_pipeline_id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// type in old CKAN")]),t._v("\nconfig"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\nenabled"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("              "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// is this harvester enabled at the moment")]),t._v("\nowner"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// user_id")]),t._v("\npublisher_id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// what is this?? Maybe the org the dataset is attached to ...")]),t._v("\nfrequency"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// MANUAL, DAILY etc")]),t._v("\n")])])]),a("h3",{attrs:{id:"ui"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ui"}},[t._v("#")]),t._v(" UI")]),t._v(" "),a("ul",[a("li",[t._v("Jobs UI: moves to next gen")]),t._v(" "),a("li",[t._v("Source UI: stays in classic for now …")])]),t._v(" "),a("h3",{attrs:{id:"installation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#installation"}},[t._v("#")]),t._v(" Installation")]),t._v(" "),a("p",[t._v("CKAN Next Gen is in active development and is being deployed in production.")]),t._v(" "),a("p",[t._v("You can find the code here:")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://gitlab.com/datopian/ckan-ng-harvester-core",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://gitlab.com/datopian/ckan-ng-harvester-core"),a("OutboundLink")],1)]),t._v(" "),a("h3",{attrs:{id:"run-it-standalone"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#run-it-standalone"}},[t._v("#")]),t._v(" Run it standalone")]),t._v(" "),a("p",[t._v("TODO")]),t._v(" "),a("h3",{attrs:{id:"how-to-integrate-with-ckan-classic"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#how-to-integrate-with-ckan-classic"}},[t._v("#")]),t._v(" How to integrate with CKAN Classic")]),t._v(" "),a("p",[t._v("Config in CKAN MetaStore, ETL in new System")]),t._v(" "),a("ul",[a("li",[t._v("Keep storage and config in CKAN MetaStore (e.g. CKAN Classic)")]),t._v(" "),a("li",[t._v("New ETL system for the actual harvesting process")])]),t._v(" "),a("p",[a("strong",[t._v("Pulling Config")])]),t._v(" "),a("ul",[a("li",[t._v("Define a spec format for sources")]),t._v(" "),a("li",[t._v("Script to convert this to Airflow DAGs")]),t._v(" "),a("li",[t._v("Script to convert CKAN Harvest sources into the spec and hence into Airflow DAGs")])]),t._v(" "),a("p",[a("strong",[t._v("Showing Status and Errors")])]),t._v(" "),a("ul",[a("li",[t._v("We create a viewer from Airflow status => JS SPA")]),t._v(" "),a("li",[t._v("and then embed in CKAN Classic Admin UI")])]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_64a54b54",graph:t.$dataBlock.mermaid_64a54b54}}),a("p",[t._v("More detailed version:")]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_64a54b22",graph:t.$dataBlock.mermaid_64a54b22}}),a("h3",{attrs:{id:"how-do-i"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#how-do-i"}},[t._v("#")]),t._v(" How do I …")]),t._v(" "),a("p",[t._v("Support parent-child relationships in harvested datasets e.g. in data.json?")]),t._v(" "),a("p",[t._v("Enhance / transform incoming datasets e.g. assigning topics based on sources e.g. this is geodata")]),t._v(" "),a("h2",{attrs:{id:"appendix-ckan-classic-harvesting-in-detail"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#appendix-ckan-classic-harvesting-in-detail"}},[t._v("#")]),t._v(" Appendix: CKAN Classic Harvesting in Detail")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/ckan/ckanext-harvest",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/ckan/ckanext-harvest"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("README is excellent and def worth reading - key parts of that are also below.")]),t._v(" "),a("h3",{attrs:{id:"key-aspects"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#key-aspects"}},[t._v("#")]),t._v(" Key Aspects")]),t._v(" "),a("ul",[a("li",[t._v("Redis and AMQP (does anyone use AMQP)")]),t._v(" "),a("li",[t._v("Logs to database with API access (off by default) - "),a("a",{attrs:{href:"https://github.com/ckan/ckanext-harvest#database-logger-configurationoptional",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/ckan/ckanext-harvest#database-logger-configurationoptional"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("Dataset name generation (to avoid overwriting)")]),t._v(" "),a("li",[t._v("Send mail when harvesting fails")]),t._v(" "),a("li",[t._v("CLI - "),a("a",{attrs:{href:"https://github.com/ckan/ckanext-harvest#command-line-interface",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/ckan/ckanext-harvest#command-line-interface"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("Authorization - "),a("a",{attrs:{href:"https://github.com/ckan/ckanext-harvest#authorization",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/ckan/ckanext-harvest#authorization"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("Built in CKAN harvester - "),a("a",{attrs:{href:"https://github.com/ckan/ckanext-harvest#the-ckan-harvester",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/ckan/ckanext-harvest#the-ckan-harvester"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("Running it: you run the queue listeners (gather )")])]),t._v(" "),a("p",[t._v("Existing harvesters")]),t._v(" "),a("ul",[a("li",[t._v("CKAN - ckanext-harvest")]),t._v(" "),a("li",[t._v("DCAT - "),a("a",{attrs:{href:"https://github.com/ckan/ckanext-dcat/tree/master/ckanext/dcat/harvesters",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/ckan/ckanext-dcat/tree/master/ckanext/dcat/harvesters"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("Spatial - "),a("a",{attrs:{href:"https://github.com/ckan/ckanext-spatial/tree/master/ckanext/spatial/harvesters",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/ckan/ckanext-spatial/tree/master/ckanext/spatial/harvesters"),a("OutboundLink")],1)])]),t._v(" "),a("h3",{attrs:{id:"domain-model-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#domain-model-2"}},[t._v("#")]),t._v(" Domain model")]),t._v(" "),a("p",[t._v("See "),a("a",{attrs:{href:"https://github.com/ckan/ckanext-harvest/blob/master/ckanext/harvest/model/__init__.py",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/ckan/ckanext-harvest/blob/master/ckanext/harvest/model/__init__.py"),a("OutboundLink")],1)]),t._v(" "),a("ul",[a("li",[t._v("HarvestSource - a remote source for harvesting datasets from e.g. a CSW server or CKAN instance")]),t._v(" "),a("li",[t._v("HarvestJob - a job to do the harvesting (done in 2 stages: gather and then fetch and import). This is basically state for the overall process of doing a harvest.")]),t._v(" "),a("li",[t._v("HarvestObject - job to harvest one dataset. Also holds dataset on the remote instance (id / url)")]),t._v(" "),a("li",[t._v("HarvestGatherError")]),t._v(" "),a("li",[t._v("HarvestObjectError")]),t._v(" "),a("li",[t._v("HarvestLog")])]),t._v(" "),a("h4",{attrs:{id:"harvest-source-objects"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#harvest-source-objects"}},[t._v("#")]),t._v(" Harvest Source Objects")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/ckan/ckanext-harvest/blob/master/ckanext/harvest/model/__init__.py#L230-L245",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/ckan/ckanext-harvest/blob/master/ckanext/harvest/model/__init__.py#L230-L245"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# harvest_source_table")]),t._v("\nColumn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" primary_key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("make_uuid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nColumn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'url'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nullable"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("False")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nColumn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'title'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("u''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nColumn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'description'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("u''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nColumn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'config'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("u''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nColumn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'created'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DateTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("utcnow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nColumn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'type'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nullable"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("False")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nColumn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'active'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Boolean"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nColumn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user_id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("u''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nColumn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'publisher_id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("u''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nColumn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'frequency'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("u'MANUAL'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nColumn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'next_run'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DateTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# not needed")]),t._v("\n")])])]),a("h4",{attrs:{id:"harvest-error-and-log-objects"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#harvest-error-and-log-objects"}},[t._v("#")]),t._v(" Harvest Error and Log Objects")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/ckan/ckanext-harvest/blob/master/ckanext/harvest/model/__init__.py#L303-L331",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/ckan/ckanext-harvest/blob/master/ckanext/harvest/model/__init__.py#L303-L331"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# New table")]),t._v("\nharvest_gather_error_table "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Table"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'harvest_gather_error'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" primary_key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("make_uuid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'harvest_job_id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ForeignKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'harvest_job.id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'message'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'created'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DateTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("utcnow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# New table")]),t._v("\nharvest_object_error_table "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Table"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'harvest_object_error'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" primary_key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("make_uuid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'harvest_object_id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ForeignKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'harvest_object.id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'message'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stage'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'line'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Integer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'created'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DateTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("utcnow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Harvest Log table")]),t._v("\nharvest_log_table "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Table"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'harvest_log'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" primary_key"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("make_uuid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'content'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnicodeText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nullable"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("False")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'level'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Enum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'DEBUG'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'INFO'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'WARNING'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ERROR'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'CRITICAL'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'log_level'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    Column"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'created'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" types"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DateTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" default"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("utcnow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("h3",{attrs:{id:"key-components"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#key-components"}},[t._v("#")]),t._v(" Key components")]),t._v(" "),a("ul",[a("li",[t._v("Configuration: HarvestSource objects")]),t._v(" "),a("li",[t._v("Pipelines: Gather, Fetch, Import stages in a given harvest extension")]),t._v(" "),a("li",[t._v("Runner: bespoke queue system (backed by Redis or AMQP). Scheduler is external e.g. Cron")]),t._v(" "),a("li",[t._v("Logging: logged into CKAN DB (as Harvest Errors)")]),t._v(" "),a("li",[t._v("Interface: API, Web UI and CLI")]),t._v(" "),a("li",[t._v("Storage:\n"),a("ul",[a("li",[t._v("Final: Datasets are in CKAN MetaStore")]),t._v(" "),a("li",[t._v("Intermediate: HarvestObject in CKAN MetaStore")])])])]),t._v(" "),a("h3",{attrs:{id:"flow"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#flow"}},[t._v("#")]),t._v(" Flow")]),t._v(" "),a("ol",{attrs:{start:"0"}},[a("li",[a("em",[t._v("Harvest run:")]),t._v(" a regular run of the Harvester that generates a HarvestJob object. This is then passed to gather stage. This is what is generated by cron "),a("code",[t._v("harvest run")]),t._v(" execution (or from web UI)")]),t._v(" "),a("li",[t._v("The "),a("strong",[t._v("gather")]),t._v(" stage compiles all the resource identifiers that need to be fetched in the next stage (e.g. in a CSW server, it will perform a GetRecords operation).")]),t._v(" "),a("li",[t._v("The "),a("strong",[t._v("fetch")]),t._v(" stage gets the contents of the remote objects and stores them in the database (e.g. in a CSW server, it will perform an GetRecordById operations).")]),t._v(" "),a("li",[t._v("The "),a("strong",[t._v("import")]),t._v(" stage performs any necessary actions on the fetched resource (generally creating a CKAN package, but it can be anything the extension needs).")])]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_64a53c0e",graph:t.$dataBlock.mermaid_64a53c0e}}),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("gather_stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" harvest_job"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v("'''\n    The gather stage will receive a HarvestJob object and will be\n    responsible for:\n        - gathering all the necessary objects to fetch on a later.\n          stage (e.g. for a CSW server, perform a GetRecords request)\n        - creating the necessary HarvestObjects in the database, specifying\n          the guid and a reference to its job. The HarvestObjects need a\n          reference date with the last modified date for the resource, this\n          may need to be set in a different stage depending on the type of\n          source.\n        - creating and storing any suitable HarvestGatherErrors that may\n          occur.\n        - returning a list with all the ids of the created HarvestObjects.\n        - to abort the harvest, create a HarvestGatherError and raise an\n          exception. Any created HarvestObjects will be deleted.\n\n    :param harvest_job: HarvestJob object\n    :returns: A list of HarvestObject ids\n    '''")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch_stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" harvest_object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v("'''\n    The fetch stage will receive a HarvestObject object and will be\n    responsible for:\n        - getting the contents of the remote object (e.g. for a CSW server,\n          perform a GetRecordById request).\n        - saving the content in the provided HarvestObject.\n        - creating and storing any suitable HarvestObjectErrors that may\n          occur.\n        - returning True if everything is ok (ie the object should now be\n          imported), \"unchanged\" if the object didn't need harvesting after\n          all (ie no error, but don't continue to import stage) or False if\n          there were errors.\n\n    :param harvest_object: HarvestObject object\n    :returns: True if successful, 'unchanged' if nothing to import after\n              all, False if not successful\n    '''")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("import_stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" harvest_object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v("'''\n    The import stage will receive a HarvestObject object and will be\n    responsible for:\n        - performing any necessary action with the fetched object (e.g.\n          create, update or delete a CKAN package).\n          Note: if this stage creates or updates a package, a reference\n          to the package should be added to the HarvestObject.\n        - setting the HarvestObject.package (if there is one)\n        - setting the HarvestObject.current for this harvest:\n           - True if successfully created/updated\n           - False if successfully deleted\n        - setting HarvestObject.current to False for previous harvest\n          objects of this harvest source if the action was successful.\n        - creating and storing any suitable HarvestObjectErrors that may\n          occur.\n        - creating the HarvestObject - Package relation (if necessary)\n        - returning True if the action was done, \"unchanged\" if the object\n          didn't need harvesting after all or False if there were errors.\n\n    NB You can run this stage repeatedly using 'paster harvest import'.\n\n    :param harvest_object: HarvestObject object\n    :returns: True if the action was done, \"unchanged\" if the object didn't\n              need harvesting after all or False if there were errors.\n    '''")]),t._v("\n")])])]),a("h3",{attrs:{id:"ui-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ui-2"}},[t._v("#")]),t._v(" UI")]),t._v(" "),a("p",[t._v("Harvest admin portal")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://i.imgur.com/Y0cyrUG.png",alt:""}})]),t._v(" "),a("p",[t._v("Add a Harvest Source")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://i.imgur.com/uoBFAjY.png",alt:""}})]),t._v(" "),a("p",[t._v("Clicking on Harvest Source gives you list of datasets harvested")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://i.imgur.com/hIRrDHP.png",alt:""}})]),t._v(" "),a("p",[t._v("Clicking on about gives you…")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://i.imgur.com/S9GTl9n.png",alt:""}})]),t._v(" "),a("p",[t._v("Admin view of a particular (Harvest) source")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://i.imgur.com/Loeshhv.png",alt:""}})]),t._v(" "),a("p",[t._v("Edit harvester")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://i.imgur.com/3SOuCm5.png",alt:""}})]),t._v(" "),a("p",[t._v("Jobs summary")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://i.imgur.com/QwD7nHi.png",alt:""}})]),t._v(" "),a("p",[t._v("Individual jobs")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://i.imgur.com/ljKEk0l.png",alt:""}})])],1)}),[],!1,null,null,null);"function"==typeof n&&n(r);e.default=r.exports}}]);