<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deployment | Datopian Tech</title>
    <meta name="generator" content="VuePress 1.7.0">
    
    <meta name="description" content="An overview of our technology">
    
    <link rel="preload" href="/assets/css/0.styles.d75de8d6.css" as="style"><link rel="preload" href="/assets/js/app.83ee3c0d.js" as="script"><link rel="preload" href="/assets/js/3.fa4bc789.js" as="script"><link rel="preload" href="/assets/js/71.5ea64cfd.js" as="script"><link rel="prefetch" href="/assets/js/10.638da2b7.js"><link rel="prefetch" href="/assets/js/11.17e0f31f.js"><link rel="prefetch" href="/assets/js/12.79e6097b.js"><link rel="prefetch" href="/assets/js/13.6eb9e3f2.js"><link rel="prefetch" href="/assets/js/14.321278ec.js"><link rel="prefetch" href="/assets/js/15.b6fc4d5c.js"><link rel="prefetch" href="/assets/js/16.0706ce2b.js"><link rel="prefetch" href="/assets/js/17.b381cf63.js"><link rel="prefetch" href="/assets/js/18.3ebc898b.js"><link rel="prefetch" href="/assets/js/19.69d5ac20.js"><link rel="prefetch" href="/assets/js/20.7083d06c.js"><link rel="prefetch" href="/assets/js/21.49fa9fe8.js"><link rel="prefetch" href="/assets/js/22.154f4b66.js"><link rel="prefetch" href="/assets/js/23.4dc144f6.js"><link rel="prefetch" href="/assets/js/24.cc815849.js"><link rel="prefetch" href="/assets/js/25.ce5ada67.js"><link rel="prefetch" href="/assets/js/26.7e80a33f.js"><link rel="prefetch" href="/assets/js/27.1f061470.js"><link rel="prefetch" href="/assets/js/28.3c051140.js"><link rel="prefetch" href="/assets/js/29.965e33c4.js"><link rel="prefetch" href="/assets/js/30.b55d7f51.js"><link rel="prefetch" href="/assets/js/31.33b4e3cc.js"><link rel="prefetch" href="/assets/js/32.ea642099.js"><link rel="prefetch" href="/assets/js/33.946f15c2.js"><link rel="prefetch" href="/assets/js/34.d8bbaa89.js"><link rel="prefetch" href="/assets/js/35.fc278665.js"><link rel="prefetch" href="/assets/js/36.3e6136c3.js"><link rel="prefetch" href="/assets/js/37.40891321.js"><link rel="prefetch" href="/assets/js/38.6acf3457.js"><link rel="prefetch" href="/assets/js/39.5c089959.js"><link rel="prefetch" href="/assets/js/4.56b57a79.js"><link rel="prefetch" href="/assets/js/40.428fc145.js"><link rel="prefetch" href="/assets/js/41.ed41f981.js"><link rel="prefetch" href="/assets/js/42.69642908.js"><link rel="prefetch" href="/assets/js/43.735df8f3.js"><link rel="prefetch" href="/assets/js/44.d7f00d32.js"><link rel="prefetch" href="/assets/js/45.01aa22e7.js"><link rel="prefetch" href="/assets/js/46.95143001.js"><link rel="prefetch" href="/assets/js/47.af314171.js"><link rel="prefetch" href="/assets/js/48.79db91df.js"><link rel="prefetch" href="/assets/js/49.2bde88a9.js"><link rel="prefetch" href="/assets/js/5.9745c567.js"><link rel="prefetch" href="/assets/js/50.9129941e.js"><link rel="prefetch" href="/assets/js/51.b269d2ad.js"><link rel="prefetch" href="/assets/js/52.635d5ff9.js"><link rel="prefetch" href="/assets/js/53.c7f27608.js"><link rel="prefetch" href="/assets/js/54.fa00a9cd.js"><link rel="prefetch" href="/assets/js/55.b0f25fa3.js"><link rel="prefetch" href="/assets/js/56.b267a606.js"><link rel="prefetch" href="/assets/js/57.d22c2b48.js"><link rel="prefetch" href="/assets/js/58.951d4e34.js"><link rel="prefetch" href="/assets/js/59.af3e6d1a.js"><link rel="prefetch" href="/assets/js/6.884850f8.js"><link rel="prefetch" href="/assets/js/60.1fcd2664.js"><link rel="prefetch" href="/assets/js/61.8eabe431.js"><link rel="prefetch" href="/assets/js/62.ae37d327.js"><link rel="prefetch" href="/assets/js/63.4909605b.js"><link rel="prefetch" href="/assets/js/64.54feb24c.js"><link rel="prefetch" href="/assets/js/65.78e5aadb.js"><link rel="prefetch" href="/assets/js/66.2744a185.js"><link rel="prefetch" href="/assets/js/67.0d982f82.js"><link rel="prefetch" href="/assets/js/68.26fc110b.js"><link rel="prefetch" href="/assets/js/69.80229dbf.js"><link rel="prefetch" href="/assets/js/7.7e8bc420.js"><link rel="prefetch" href="/assets/js/70.6dbe86bf.js"><link rel="prefetch" href="/assets/js/72.e6aa1f00.js"><link rel="prefetch" href="/assets/js/73.f3c75981.js"><link rel="prefetch" href="/assets/js/74.8e3e50e5.js"><link rel="prefetch" href="/assets/js/75.a999e369.js"><link rel="prefetch" href="/assets/js/76.43f17b74.js"><link rel="prefetch" href="/assets/js/77.bfeedf51.js"><link rel="prefetch" href="/assets/js/78.3a5c4169.js"><link rel="prefetch" href="/assets/js/79.4edb0ee4.js"><link rel="prefetch" href="/assets/js/8.822440c2.js"><link rel="prefetch" href="/assets/js/80.455a3bb5.js"><link rel="prefetch" href="/assets/js/81.4e58f07a.js"><link rel="prefetch" href="/assets/js/82.31ee1f4e.js"><link rel="prefetch" href="/assets/js/83.5dd63d5c.js"><link rel="prefetch" href="/assets/js/84.d25a09fe.js"><link rel="prefetch" href="/assets/js/85.3b60c237.js"><link rel="prefetch" href="/assets/js/9.63d821ea.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.62a8c583.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d75de8d6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Datopian Tech</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Features" class="dropdown-title"><span class="title">Features</span> <span class="arrow down"></span></button> <button type="button" aria-label="Features" class="mobile-dropdown-title"><span class="title">Features</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/views/" class="nav-link">
  Views
</a></li></ul></div></div> <a href="https://github.com/datopian/tech.datopian.com" target="_blank" rel="noopener noreferrer" class="repo-link">
    Contribute!
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Features" class="dropdown-title"><span class="title">Features</span> <span class="arrow down"></span></button> <button type="button" aria-label="Features" class="mobile-dropdown-title"><span class="title">Features</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/views/" class="nav-link">
  Views
</a></li></ul></div></div> <a href="https://github.com/datopian/tech.datopian.com" target="_blank" rel="noopener noreferrer" class="repo-link">
    Contribute!
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Deployment</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/migration/ccd/deployment.html#installation" class="sidebar-link">Installation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/migration/ccd/deployment.html#dependencies" class="sidebar-link">Dependencies</a></li><li class="sidebar-sub-header"><a href="/migration/ccd/deployment.html#source-files-and-configuration" class="sidebar-link">Source files and configuration</a></li></ul></li><li><a href="/migration/ccd/deployment.html#running" class="sidebar-link">Running</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/migration/ccd/deployment.html#migrate-data" class="sidebar-link">Migrate Data</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/migration/ccd/deployment.html#migrate-database" class="sidebar-link">Migrate Database</a></li><li class="sidebar-sub-header"><a href="/migration/ccd/deployment.html#migrate-files" class="sidebar-link">Migrate files</a></li><li class="sidebar-sub-header"><a href="/migration/ccd/deployment.html#repopulate-search-index" class="sidebar-link">Repopulate Search Index</a></li></ul></li><li><a href="/migration/ccd/deployment.html#next-steps" class="sidebar-link">Next Steps</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="deployment"><a href="#deployment" class="header-anchor">#</a> Deployment</h1> <p>This is a step by step guide covering all the necessary steps to deploy CKAN using custom template on a new machine.</p> <p>The guide will try to cover all Linux-based operating systems, but some commands might be specific to Ubuntu and its derivatives. However, links containing further information were added in order to simplify the installation process on other operating systems as well.</p> <h2 id="installation"><a href="#installation" class="header-anchor">#</a> Installation</h2> <h3 id="dependencies"><a href="#dependencies" class="header-anchor">#</a> Dependencies</h3> <ul><li>A GNU/Linux operating system with good internet connectivity.</li> <li>Unrestricted access to external domains, such as <strong><a href="https://github.com/" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong>, <strong><a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">DockerHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong>, etc.</li> <li>git, docker-engine (docker) and docker-compose</li></ul> <p>First we need to install <strong><a href="https://help.github.com/en/articles/set-up-git" target="_blank" rel="noopener noreferrer">git<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> and <strong><a href="https://docs.docker.com/compose/install/" target="_blank" rel="noopener noreferrer">docker-compose<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong> (<em>docker-compose</em> should already have <em>docker</em> as dependency. If this is not the case follow the <strong><a href="https://docs.docker.com/v17.12/install/" target="_blank" rel="noopener noreferrer">official documentation on installing docker<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong>):</p> <div class="language- extra-class"><pre class="language-text"><code>sudo apt-get update
sudo apt-get install git docker-compose build-essential
</code></pre></div><p>Then start and enable the docker service and verify operation</p> <div class="language- extra-class"><pre class="language-text"><code>sudo systemctl start docker
sudo systemctl enable docker
sudo docker info
</code></pre></div><h4 id="local-mirrors"><a href="#local-mirrors" class="header-anchor">#</a> Local mirrors</h4> <p>In case you need to use your local county mirrors as pip registry please set pip index URL:</p> <div class="language- extra-class"><pre class="language-text"><code>export PIP_INDEX_URL=&lt;&lt;https://local-mirror-url.xy&gt;&gt;
</code></pre></div><h4 id="extra-dependencies"><a href="#extra-dependencies" class="header-anchor">#</a> Extra dependencies</h4> <ul><li>You will also need a SMTP server and its credentials for CKAN to work properly. This will not obstacle deployment, CKAN will be up and running, but won’t be able to send emails (e.g. on password reset). You will be asked to provide SMTP server credentials while running <code>make secret</code> script, see below.</li></ul> <h3 id="source-files-and-configuration"><a href="#source-files-and-configuration" class="header-anchor">#</a> Source files and configuration</h3> <p>Now we have the runtime, next we need to download the cluster configuration files and build the services.</p> <p>Navigate to where you want the source files to live on your server (e.g. <code>/opt</code>) and clone the repository:</p> <div class="language- extra-class"><pre class="language-text"><code>cd /opt
git clone https://github.com/ViderumGlobal/ckan-cloud-docker.git
cd ckan-cloud-docker
</code></pre></div><h4 id="environment-variables"><a href="#environment-variables" class="header-anchor">#</a> Environment variables</h4> <p>To create or update files with secrets and env vars run and follow all steps:</p> <div class="language- extra-class"><pre class="language-text"><code>make secret
</code></pre></div><h4 id="traefik-proxy-service"><a href="#traefik-proxy-service" class="header-anchor">#</a> Traefik proxy service</h4> <p>Traefik is the entry point from the outside world. It binds to the default HTTP (80) and HTTPS (443) ports and handles requests by forwarding them to the appropriate services within the stack. In our case, it will point to Nginx serving the CKAN web app.</p> <p>Traefik will set up SSL for the website. There are two ways of doing this:</p> <ol><li>By having a provided certificate we need to install</li> <li>By obtaining and installing a Let’s Encrypt certificate</li></ol> <h5 id="install-a-provided-certificate"><a href="#install-a-provided-certificate" class="header-anchor">#</a> Install a provided certificate</h5> <p>To install an existing SSL certificate we need to use the <code>traefik/traefik_custom_ssl.toml</code> file. Make sure this file is the one mounted in the Traefik container, and not the default (which will attempt to obtain a Let’s Encrypt certificate, see next step).</p> <p>The certificate chain and private key need to be copied in the <code>traefik/certs</code> directory using these exact names:</p> <ul><li><code>domain.cert</code> for the certificate [chain] of the domain</li> <li><code>domain.key</code> for the private key</li></ul> <p>Modifying these names is possible by also altering the <code>traefik.toml</code> configuration file. This might be needed for installing multiple certificates, for example (subdomains, alternate TLDs etc.).</p> <h5 id="set-up-let-s-encrypt"><a href="#set-up-let-s-encrypt" class="header-anchor">#</a> Set up Let’s Encrypt</h5> <p>Traefik needs strict permissions in order to run Let’s Encrypt (<strong><a href="https://www.digitalocean.com/community/tutorials/how-to-use-traefik-as-a-reverse-proxy-for-docker-containers-on-ubuntu-18-04" target="_blank" rel="noopener noreferrer">more info<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong>):</p> <div class="language- extra-class"><pre class="language-text"><code>chmod 600 traefik/acme.json
</code></pre></div><p>Finally, edit traefik/traefik.toml file</p> <div class="language- extra-class"><pre class="language-text"><code>vim traefik/traefik.toml
</code></pre></div><p>Traefik will attempt to obtain a Let’s Encrypt SSL certificate. In order for this to happen, the following configuration items need to be filled in:</p> <ul><li><code>email = &quot;admin@example.com&quot;</code></li></ul> <blockquote><p>IMPORTANT: Use FQDN for both ‘main’ and ‘rule’ entries.</p></blockquote> <p>This is the <a href="https://letsencrypt.org/docs/expiration-emails/" target="_blank" rel="noopener noreferrer">contact email<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for Let’s Encrypt</p> <ul><li><code>main = &quot;example.com&quot;</code><br>
This is the domain for which Let’s Encrypt will generate a certificate for</li></ul> <hr> <p>In addition to SSL specific configuration, there is one more line you need to adjust:</p> <ul><li><code>rule = &quot;Host:example.com&quot;</code><br>
This is the domain name that Traefik should respond to. Requests to any other domain not configured as a <code>Host</code> rule will result in Traefik not being able to handle the request.</li></ul> <blockquote><p>Note: All the necessary configuration items are marked with <code>TODO</code> flags in the <code>traefik.toml</code> configuration file.</p></blockquote> <hr> <p>This should be enough for the basic installation. In case you need to tweak versions or other initialization parameters for CKAN, you need these two files:</p> <ul><li><p><code>docker-compose/ckan-conf-templates/{instance-id}-theme-production.ini</code><br>
This is the file used to generate the CKAN main configuration file.</p></li> <li><p><code>.docker-compose.{instance-id}-theme.yaml</code><br>
This is the file that defines the services used by this instance.</p></li></ul> <h2 id="running"><a href="#running" class="header-anchor">#</a> Running</h2> <p><strong>To run the instance:</strong></p> <div class="language- extra-class"><pre class="language-text"><code>sudo make start O=&lt;&lt;instance-id&gt;&gt;
</code></pre></div><p><strong>To stop it, run:</strong></p> <div class="language- extra-class"><pre class="language-text"><code>sudo make stop O=&lt;&lt;instance-id&gt;&gt;
</code></pre></div><p><strong>To destroy the instance, run:</strong></p> <div class="language- extra-class"><pre class="language-text"><code>sudo make down O=&lt;&lt;instance-id&gt;&gt;
</code></pre></div><p><strong>To destroy the instance, together with volumes, databases etc., run:</strong></p> <div class="language- extra-class"><pre class="language-text"><code>sudo make remove_volumes O=&lt;&lt;instance-id&gt;&gt;
</code></pre></div><p><em>If you want to tweak the source files, typically you need to destroy the instance and run it again once you’re done editing. The choice of removing the volumes in the process is up to you.</em></p> <h2 id="migrate-data"><a href="#migrate-data" class="header-anchor">#</a> Migrate Data</h2> <h3 id="migrate-database"><a href="#migrate-database" class="header-anchor">#</a> Migrate Database</h3> <p>You will need public URLs to database dumps.</p> <div class="language- extra-class"><pre class="language-text"><code>DB_DUMP_URL=&lt;&lt;DB_DUMP_URL.gz&gt;&gt;
DATASTORE_DB_DUMP_URL=&lt;&lt;DATASTORE_DB_DUMP_URL.gz&gt;&gt;

sudo make shell O=&lt;&lt;instance-id&gt;&gt; S=ckan C='bash migrate_databases.sh $(DB_DUMP_URL) $(DATASTORE_DB_DUMP_URL)'
</code></pre></div><h3 id="migrate-files"><a href="#migrate-files" class="header-anchor">#</a> Migrate files</h3> <p><strong>For ckan-cloud devops only</strong> - Migrate data from ckan-cloud cluster to object store server (Eg: AWS S3):</p> <div class="language- extra-class"><pre class="language-text"><code># Grab the minio-mc pod name
kubectl get pods -n ckan-cloud | grep minio-mc
# SSH into the pod
kubectl exec -it minio-mc-xya-abc -n ckan-cloud sh
# Add minio server to hosts
mc config host add exporter https://host.ckan.io &lt;&lt;access-key&gt;&gt; &lt;&lt;secret-key&gt;&gt;
# Add client minio server to hosts
mc config host add receiver https://host.client.io &lt;&lt;reciever-access-key&gt;&gt; &lt;&lt;reciever-secret-key&gt;&gt;
# Depending on instance, some paths can be set to public download:
mc policy download prod/ckan/&lt;&lt;instance-id&gt;&gt;/*
# Make sure client server has bucket init with proper permissions. (IAM user owning credentials should have full access over bucket)
# Migrate data
mc cp --recursive exporter/ckan/&lt;&lt;instance-id&gt;&gt; receiver/&lt;&lt;bucket-name&gt;&gt;
</code></pre></div><p>Download the data to file system and mount on ckan persistent volumes:</p> <div class="language- extra-class"><pre class="language-text"><code>HOST=&lt;&lt;FileStorage Server&gt;&gt;
ACCESS_KEY=&lt;&lt;Access Key&gt;&gt;
SECRET_KEY=&lt;&lt;Secret Key&gt;&gt;
BUCKET=&lt;&lt;Bucket Name&gt;&gt;
STORAGE_PATH=&lt;&lt;Storage Path&gt;&gt;

bash migrate_filestorage.sh $HOST $ACCESS_KEY $SECRET_KEY $BUCKET $STORAGE_PATH
</code></pre></div><h3 id="repopulate-search-index"><a href="#repopulate-search-index" class="header-anchor">#</a> Repopulate Search Index</h3> <p>After migration rebuild the SOLR search index.</p> <div class="language- extra-class"><pre class="language-text"><code>sudo make shell O=&lt;&lt;instance-id&gt;&gt; S=ckan C='/usr/local/bin/ckan-paster --plugin=ckan search-index rebuild  -c /etc/ckan/production.ini'
</code></pre></div><h2 id="next-steps"><a href="#next-steps" class="header-anchor">#</a> Next Steps</h2> <p>Read the <a href="/migration/ccd/post-deployment">Post Deployment Guide</a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/datopian/tech.datopian.com/edit/master/migration/ccd/deployment.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Modified:</span> <span class="time">3/11/2021, 4:34:18 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.83ee3c0d.js" defer></script><script src="/assets/js/3.fa4bc789.js" defer></script><script src="/assets/js/71.5ea64cfd.js" defer></script>
  </body>
</html>
