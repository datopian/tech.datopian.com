<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DX Architecture | Datopian Tech</title>
    <meta name="generator" content="VuePress 1.7.0">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-XESJBM03F5"></script>
    <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-XESJBM03F5');</script>
    <meta name="description" content="An overview of our technology">
    
    <link rel="preload" href="/assets/css/0.styles.d75de8d6.css" as="style"><link rel="preload" href="/assets/js/app.63098cb8.js" as="script"><link rel="preload" href="/assets/js/3.d799bd9e.js" as="script"><link rel="preload" href="/assets/js/52.523e96ba.js" as="script"><link rel="prefetch" href="/assets/js/10.a7fa9182.js"><link rel="prefetch" href="/assets/js/11.17e0f31f.js"><link rel="prefetch" href="/assets/js/12.9c156b85.js"><link rel="prefetch" href="/assets/js/13.6eb9e3f2.js"><link rel="prefetch" href="/assets/js/14.c3eb8d6a.js"><link rel="prefetch" href="/assets/js/15.78b82eed.js"><link rel="prefetch" href="/assets/js/16.0706ce2b.js"><link rel="prefetch" href="/assets/js/17.01bc70f8.js"><link rel="prefetch" href="/assets/js/18.8b6554d2.js"><link rel="prefetch" href="/assets/js/19.21c8357b.js"><link rel="prefetch" href="/assets/js/20.7083d06c.js"><link rel="prefetch" href="/assets/js/21.37c39eb2.js"><link rel="prefetch" href="/assets/js/22.754367dc.js"><link rel="prefetch" href="/assets/js/23.9c23b15e.js"><link rel="prefetch" href="/assets/js/24.a3608064.js"><link rel="prefetch" href="/assets/js/25.c3ac8418.js"><link rel="prefetch" href="/assets/js/26.bc26ecc9.js"><link rel="prefetch" href="/assets/js/27.ce6779fb.js"><link rel="prefetch" href="/assets/js/28.bc68c583.js"><link rel="prefetch" href="/assets/js/29.afed14f9.js"><link rel="prefetch" href="/assets/js/30.c8803030.js"><link rel="prefetch" href="/assets/js/31.ec9a756e.js"><link rel="prefetch" href="/assets/js/32.42c71343.js"><link rel="prefetch" href="/assets/js/33.8085ba37.js"><link rel="prefetch" href="/assets/js/34.83c0c257.js"><link rel="prefetch" href="/assets/js/35.ae8f0e52.js"><link rel="prefetch" href="/assets/js/36.c56fa4f9.js"><link rel="prefetch" href="/assets/js/37.dd5be133.js"><link rel="prefetch" href="/assets/js/38.dbce98b5.js"><link rel="prefetch" href="/assets/js/39.dea553d4.js"><link rel="prefetch" href="/assets/js/4.3122edaf.js"><link rel="prefetch" href="/assets/js/40.d720389c.js"><link rel="prefetch" href="/assets/js/41.645c4c30.js"><link rel="prefetch" href="/assets/js/42.099c6f38.js"><link rel="prefetch" href="/assets/js/43.93c6114c.js"><link rel="prefetch" href="/assets/js/44.88f00e9e.js"><link rel="prefetch" href="/assets/js/45.2c3c216f.js"><link rel="prefetch" href="/assets/js/46.e2d887f4.js"><link rel="prefetch" href="/assets/js/47.787e7aea.js"><link rel="prefetch" href="/assets/js/48.316cbfd7.js"><link rel="prefetch" href="/assets/js/49.631989b3.js"><link rel="prefetch" href="/assets/js/5.a6f946d8.js"><link rel="prefetch" href="/assets/js/50.e689997c.js"><link rel="prefetch" href="/assets/js/51.94674a0a.js"><link rel="prefetch" href="/assets/js/53.811cb69c.js"><link rel="prefetch" href="/assets/js/54.c5a9ab06.js"><link rel="prefetch" href="/assets/js/55.8a0f4204.js"><link rel="prefetch" href="/assets/js/56.a29563d1.js"><link rel="prefetch" href="/assets/js/57.835aab72.js"><link rel="prefetch" href="/assets/js/58.8f0eabe5.js"><link rel="prefetch" href="/assets/js/59.fa5e629f.js"><link rel="prefetch" href="/assets/js/6.1e7b98e6.js"><link rel="prefetch" href="/assets/js/60.681e54dd.js"><link rel="prefetch" href="/assets/js/61.8bba1399.js"><link rel="prefetch" href="/assets/js/62.c8f2dd0b.js"><link rel="prefetch" href="/assets/js/63.20e461a7.js"><link rel="prefetch" href="/assets/js/64.415e8581.js"><link rel="prefetch" href="/assets/js/65.dab64550.js"><link rel="prefetch" href="/assets/js/66.aced021b.js"><link rel="prefetch" href="/assets/js/67.144ba192.js"><link rel="prefetch" href="/assets/js/68.698dda9c.js"><link rel="prefetch" href="/assets/js/69.cf1f44bc.js"><link rel="prefetch" href="/assets/js/7.1bee4d5a.js"><link rel="prefetch" href="/assets/js/70.5fea0f6c.js"><link rel="prefetch" href="/assets/js/71.fd3a5eec.js"><link rel="prefetch" href="/assets/js/72.95f45bd4.js"><link rel="prefetch" href="/assets/js/73.9d97dbd0.js"><link rel="prefetch" href="/assets/js/74.5420145d.js"><link rel="prefetch" href="/assets/js/75.4c9aee5b.js"><link rel="prefetch" href="/assets/js/76.203d13f0.js"><link rel="prefetch" href="/assets/js/77.7f4f72ab.js"><link rel="prefetch" href="/assets/js/78.ecd8ea0a.js"><link rel="prefetch" href="/assets/js/79.c1dbeae7.js"><link rel="prefetch" href="/assets/js/8.ced61209.js"><link rel="prefetch" href="/assets/js/80.21a62968.js"><link rel="prefetch" href="/assets/js/81.38a186b0.js"><link rel="prefetch" href="/assets/js/82.084e104a.js"><link rel="prefetch" href="/assets/js/83.7fab6c49.js"><link rel="prefetch" href="/assets/js/84.136c88f8.js"><link rel="prefetch" href="/assets/js/85.1b216135.js"><link rel="prefetch" href="/assets/js/86.c749ef07.js"><link rel="prefetch" href="/assets/js/9.44e9b202.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.62a8c583.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d75de8d6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Datopian Tech</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Features" class="dropdown-title"><span class="title">Features</span> <span class="arrow down"></span></button> <button type="button" aria-label="Features" class="mobile-dropdown-title"><span class="title">Features</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/views/" class="nav-link">
  Views
</a></li></ul></div></div> <a href="https://github.com/datopian/tech.datopian.com" target="_blank" rel="noopener noreferrer" class="repo-link">
    Contribute!
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Features" class="dropdown-title"><span class="title">Features</span> <span class="arrow down"></span></button> <button type="button" aria-label="Features" class="mobile-dropdown-title"><span class="title">Features</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/views/" class="nav-link">
  Views
</a></li></ul></div></div> <a href="https://github.com/datopian/tech.datopian.com" target="_blank" rel="noopener noreferrer" class="repo-link">
    Contribute!
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>DX Architecture</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dx/architecture/#introduction" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/dx/architecture/#terminology" class="sidebar-link">Terminology</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/dx/architecture/#description-of-the-ci-cd-pipeline-stages" class="sidebar-link">Description of the CI/CD pipeline stages</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/dx/architecture/#deploying-an-application" class="sidebar-link">Deploying an Application</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dx/architecture/#project-repo-layout" class="sidebar-link">Project Repo Layout</a></li></ul></li><li><a href="/dx/architecture/#faqs-todos" class="sidebar-link">FAQs / TODOs</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/dx/architecture/#gitops-best-practice" class="sidebar-link">GitOps best practice</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dx/architecture/#architecture-diagram-for-gitops" class="sidebar-link">Architecture diagram for GitOps</a></li><li class="sidebar-sub-header"><a href="/dx/architecture/#architecture-diagram-for-several-environments" class="sidebar-link">Architecture diagram for several environments</a></li><li class="sidebar-sub-header"><a href="/dx/architecture/#what-is-argo-cd-blue-green-canary-deployment-tool" class="sidebar-link">What is Argo CD? (blue/green &amp; canary deployment tool)</a></li><li class="sidebar-sub-header"><a href="/dx/architecture/#references" class="sidebar-link">References</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="dx-architecture"><a href="#dx-architecture" class="header-anchor">#</a> DX Architecture</h1> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>This document describes the target infrastructure and CI/CD pipeline architecture of CKAN Cloud on Kubernetes.</p> <p>The proposed solution architecture is intended to be simple, automated and shouldn’t require any kubernetes knowledge.</p> <p>The core of the architecture is a DevOps toolchain following GitOps best practice. It is comprised of the following tools:</p> <ul><li>Gitlab VCS</li> <li>Helm charts</li> <li>Gitlab CI push pipeline</li> <li>ArgoCD CD pull pipeline</li></ul> <p>ArgoCD is a new approach to deploy software, which follows GitOps best practice.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>If unfamiliar with GitOps please read the Appendix below.</p></div> <h2 id="terminology"><a href="#terminology" class="header-anchor">#</a> Terminology</h2> <p>We follow ArgoCD terminology:</p> <ul><li>Projects: an overall project containing one or more appplications/environments e.g. XYZ data portal</li> <li>Application: aka Instance/Environment e.g. production, staging, dev etc of XYZ data portal</li> <li>Service: a single microservice that is part of an Application</li></ul> <h2 id="description-of-the-ci-cd-pipeline-stages"><a href="#description-of-the-ci-cd-pipeline-stages" class="header-anchor">#</a> Description of the CI/CD pipeline stages</h2> <ol><li>Gitlab <strong>Repo #1</strong> (App repo): Source code is pushed to the CKAN repo</li> <li>Gitlab <strong>Repo #1</strong> (App repo): CI build pipeline is triggered</li> <li>Gitlab <strong>Repo #1</strong> (App repo): Unit tests, security scans, code quality and linters run</li> <li>Gitlab <strong>Repo #1</strong> (App repo): Docker image is built</li> <li>Gitlab <strong>Repo #1</strong> (App repo): Docker image is pushed to the Docker Registry</li> <li>Gitlab <strong>Repo #2</strong> (Helm repo): Environment repository helm chart values file is updated</li> <li>ArgoCD <strong>Repo #2</strong> (Helm repo): K8s manifests are synced with the helm environment <strong>Repo #2</strong></li></ol> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><h2 id="deploying-an-application"><a href="#deploying-an-application" class="header-anchor">#</a> Deploying an Application</h2> <ol><li>Generate a Gitlab <strong>Repo #1</strong> (Application and Helm repository) by running a one-line command<br>
A black-box for a developer (what happens under the hood):
<ul><li><strong>Repo #1</strong> (App repo + Helm Repo) a project is initialized on Gitlab with a template project files</li> <li>ArgoCD <strong>Repo #2</strong> (ArgoCD repo) config file is added with a new application to ArgoCD. From now on ArgoCD will sync <strong>Repo #2</strong> (Helm repo) with k8s</li></ul></li> <li>Push your code to <strong>Repo #1</strong> (App repo) and check your first deployment on k8s</li></ol> <h3 id="project-repo-layout"><a href="#project-repo-layout" class="header-anchor">#</a> Project Repo Layout</h3> <p>Projects live inside the <code>deploys</code> group.</p> <div class="language- extra-class"><pre class="language-text"><code># create new repo on gitlab at datopian/applications/xxx
$ git clone that-repo
$ create-ckan-k8s-app --template XXX ...
$ tree

README.md        # optional
CREATE_CKAN_K8S_APP_VERSION
.gitlab-ci.yml
helm/
  templates/...
  values/...
service0-aka-ckan-core
  Dockerfile (if custom one needed)
service1      (if customization needed)
  Dockerfile
service2      # completely specific to this application
  code
  Dockerfile
</code></pre></div><h2 id="faqs-todos"><a href="#faqs-todos" class="header-anchor">#</a> FAQs / TODOs</h2> <ul><li>How do we handle different “environments” (staging, production etc) of a given application?
<ul><li><s>ANS: different branches</s></li> <li><s>ANS: different repos</s></li> <li>ANS: different directories (or different <code>values.yml</code>)
<ul><li>When you create an application in ArgoCD you link it to a values.yml</li></ul></li> <li>TODO: What are the pros/cons of using branches vs “directory or file” approach</li></ul></li> <li>What about automated “PRs” for new service releases e.g. i update frontend service and then get a PR on helm repo</li></ul> <h2 id="gitops-best-practice"><a href="#gitops-best-practice" class="header-anchor">#</a> GitOps best practice</h2> <p>GitOps is a way of implementing Continuous Deployment for cloud native applications. It focuses on a <strong>developer-centric experience</strong> when operating infrastructure, by using tools developers are already familiar with, including Git and Continuous Deployment tools.</p> <p>The core idea of GitOps is having a Git repository that always contains declarative descriptions of the infrastructure currently desired in the production environment and an automated process to make the production environment match the described state in the repository. If you want to deploy a new application or update an existing one, you only need to update the repository - the automated process handles everything else. It’s like having cruise control for managing your applications in production.</p> <blockquote><p>GitOps: versioned CI/CD on top of declarative infrastructure. Stop scripting and start shipping.<br>
— Kelsey Hightower</p></blockquote> <h3 id="architecture-diagram-for-gitops"><a href="#architecture-diagram-for-gitops" class="header-anchor">#</a> Architecture diagram for GitOps</h3> <p><img src="https://i.imgur.com/xIiDvUT.png" alt=""></p> <h3 id="architecture-diagram-for-several-environments"><a href="#architecture-diagram-for-several-environments" class="header-anchor">#</a> Architecture diagram for several environments</h3> <p><img src="https://i.imgur.com/yl1JeUM.png" alt=""></p> <h3 id="what-is-argo-cd-blue-green-canary-deployment-tool"><a href="#what-is-argo-cd-blue-green-canary-deployment-tool" class="header-anchor">#</a> What is Argo CD? (blue/green &amp; canary deployment tool)</h3> <p>Argo CD is a declarative, GitOps continuous delivery tool for Kubernetes.</p> <p>Application definitions, configurations, and environments should be declarative and version controlled. Application deployment and lifecycle management should be automated, auditable, and easy to understand.</p> <p>Argo CD follows the GitOps pattern of using Git repositories as the source of truth for defining the desired application state. Kubernetes manifests can be specified in several ways:</p> <ul><li>kustomize applications</li> <li><strong>helm charts</strong></li> <li>ksonnet applications</li> <li>jsonnet files</li> <li>Plain directory of YAML/json manifests</li> <li>Any custom config management tool configured as a config management plugin</li></ul> <p>Argo CD automates the deployment of the desired application states in the specified target environments. Application deployments can track updates to branches, tags, or pinned to a specific version of manifests at a Git commit. See tracking strategies for additional details about the different tracking strategies available.</p> <p><img src="https://i.imgur.com/io0uEpe.png" alt=""></p> <p>Argo CD is implemented as a kubernetes controller which continuously monitors running applications and compares the current, live state against the desired target state (as specified in the Git repo). A deployed application whose live state deviates from the target state is considered OutOfSync. Argo CD reports &amp; visualizes the differences, while providing facilities to automatically or manually sync the live state back to the desired target state. Any modifications made to the desired target state in the Git repo can be automatically applied and reflected in the specified target environments.</p> <h4 id="features"><a href="#features" class="header-anchor">#</a> Features</h4> <ul><li>Automated deployment of applications to specified target environments</li> <li>Support for multiple config management/templating tools (Kustomize, Helm, Ksonnet, Jsonnet, plain-YAML)</li> <li>Ability to manage and deploy to multiple clusters</li> <li>SSO Integration (OIDC, OAuth2, LDAP, SAML 2.0, GitHub, GitLab, Microsoft, LinkedIn)</li> <li>Multi-tenancy and RBAC policies for authorization</li> <li>Rollback/Roll-anywhere to any application configuration committed in Git repository</li> <li>Health status analysis of application resources</li> <li>Automated configuration drift detection and visualization</li> <li>Automated or manual syncing of applications to its desired state</li> <li>Web UI which provides real-time view of application activity</li> <li>CLI for automation and CI integration</li> <li>Webhook integration (GitHub, BitBucket, GitLab)</li> <li>Access tokens for automation</li> <li><strong>PreSync, Sync, PostSync hooks to support complex application rollouts (e.g.blue/green &amp; canary upgrades)</strong></li> <li>Audit trails for application events and API calls</li> <li>Prometheus metrics</li> <li>Parameter overrides for overriding ksonnet/helm parameters in Git</li></ul> <h3 id="references"><a href="#references" class="header-anchor">#</a> References</h3> <ul><li>GitOps <a href="https://www.gitops.tech/" target="_blank" rel="noopener noreferrer">https://www.gitops.tech/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>ArgoCD <a href="https://argoproj.github.io/argo-cd/" target="_blank" rel="noopener noreferrer">https://argoproj.github.io/argo-cd/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/datopian/tech.datopian.com/edit/master/dx/architecture/README.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Modified:</span> <span class="time">2/4/2022, 5:37:35 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.63098cb8.js" defer></script><script src="/assets/js/3.d799bd9e.js" defer></script><script src="/assets/js/52.523e96ba.js" defer></script>
  </body>
</html>
