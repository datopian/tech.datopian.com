(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{411:function(e,t,a){"use strict";a.r(t);var n=a(18),o=Object(n.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h2",{attrs:{id:"run-a-data-migration-between-environments"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#run-a-data-migration-between-environments"}},[e._v("#")]),e._v(" Run A Data Migration Between Environments")]),e._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),a("p",[e._v("This article is still under testing and development.")])]),e._v(" "),a("ol",[a("li",[e._v("Install kubectl and kubectx.")]),e._v(" "),a("li",[a("a",{attrs:{href:"/dx-data-migration.yaml"}},[e._v("Download the file containing the manifests")]),e._v(" and personalize it according to your needs. Most specifically: environment variables in "),a("code",[e._v("Secret/envvars")]),e._v(", and "),a("code",[e._v("ConfigMap/files")]),e._v("â€™ "),a("code",[e._v("migrate.sh")]),e._v(" file.")]),e._v(" "),a("li",[e._v("Apply the manifests in a new namespace:"),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("kubectx gke_ckan-cloud_europe-west1-c_ckan-cloud-prod-eu\nkubectl create namespace jobs-project-name\nkubectl -n jobs-project-name delete "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("jobs")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")]),e._v("kubectl -n jobs-project-name get "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("jobs")]),e._v(" -o custom-columns"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(":.metadata.name"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("`")])]),e._v("\nkubectl -n jobs-project-name apply -f dx-data-migration.yaml\n")])])])]),e._v(" "),a("li",[e._v("Run "),a("a",{attrs:{href:"https://gitlab.com/datopian/experiments/dx-terraform/-/blob/master/provision_cloud_sql_ckan.sql#L16-89",target:"_blank",rel:"noopener noreferrer"}},[e._v("a few provisioning SQL queries"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("li",[e._v("Migrate the blobs into Google Cloud Storage."),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("# Get a shell into Minio's CLI, deployed in ckan-cloud cluster and namespace\n$ kubectl exec -it -n ckan-cloud minio-mc-7b9549d546-vqq8s -- sh\n\n# Inside the pod, you have access to mc binary, which is essentially all you need\n$ mc config host list   # Get a list of all configured hosts\n\n# Copy something:\n$ mc cp -r prod/ckan/montreal-dev/uploads dx/dx-montreal-staging/\n")])])])])]),e._v(" "),a("p",[e._v("For reference, here are the most commonly used hosts that are already configured:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("prod")]),e._v(" is the main minio bucket that lives at "),a("a",{attrs:{href:"http://cc-p-minio.ckan.io",target:"_blank",rel:"noopener noreferrer"}},[e._v("cc-p-minio.ckan.io"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("code",[e._v("gcs")]),e._v(" is the Google Storage account in ckan-cloud project")]),e._v(" "),a("li",[a("code",[e._v("dx")]),e._v(" is the Google Storage from DX project")])]),e._v(" "),a("h2",{attrs:{id:"references"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[e._v("#")]),e._v(" References")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://medium.com/mavenlink-product-development/migrating-postgres-to-google-cloud-sql-2637b1caab4d",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://medium.com/mavenlink-product-development/migrating-postgres-to-google-cloud-sql-2637b1caab4d"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://dba.stackexchange.com/questions/204490/how-to-restore-a-pg-dumpall-dump-without-create-index",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://dba.stackexchange.com/questions/204490/how-to-restore-a-pg-dumpall-dump-without-create-index"),a("OutboundLink")],1)])]),e._v(" "),a("h2",{attrs:{id:"how-to-improve-it-from-now-on"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#how-to-improve-it-from-now-on"}},[e._v("#")]),e._v(" How To Improve It From Now On")]),e._v(" "),a("ol",[a("li",[e._v("Improve documentation.")]),e._v(" "),a("li",[e._v("Create something like a CLI in Python.")]),e._v(" "),a("li",[e._v("Create a Kubernetes Operator (can also be in Python). It does the same thing as 2, in the Kubernetes way.")])])])}),[],!1,null,null,null);t.default=o.exports}}]);