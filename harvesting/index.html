<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Harvesting | Datopian Tech</title>
    <meta name="generator" content="VuePress 1.7.0">
    
    <meta name="description" content="An overview of our technology">
    
    <link rel="preload" href="/assets/css/0.styles.d75de8d6.css" as="style"><link rel="preload" href="/assets/js/app.90a758e8.js" as="script"><link rel="preload" href="/assets/js/3.fa4bc789.js" as="script"><link rel="preload" href="/assets/js/61.ce00e677.js" as="script"><link rel="prefetch" href="/assets/js/10.b87b2a13.js"><link rel="prefetch" href="/assets/js/11.17e0f31f.js"><link rel="prefetch" href="/assets/js/12.79e6097b.js"><link rel="prefetch" href="/assets/js/13.6eb9e3f2.js"><link rel="prefetch" href="/assets/js/14.321278ec.js"><link rel="prefetch" href="/assets/js/15.cab52d1d.js"><link rel="prefetch" href="/assets/js/16.b3caaad1.js"><link rel="prefetch" href="/assets/js/17.b381cf63.js"><link rel="prefetch" href="/assets/js/18.36cd8519.js"><link rel="prefetch" href="/assets/js/19.35637ff7.js"><link rel="prefetch" href="/assets/js/20.ba881edd.js"><link rel="prefetch" href="/assets/js/21.40d855dc.js"><link rel="prefetch" href="/assets/js/22.d52ae8bc.js"><link rel="prefetch" href="/assets/js/23.0f341fa2.js"><link rel="prefetch" href="/assets/js/24.cfd3900f.js"><link rel="prefetch" href="/assets/js/25.f95615ff.js"><link rel="prefetch" href="/assets/js/26.43bea64a.js"><link rel="prefetch" href="/assets/js/27.117bc7f0.js"><link rel="prefetch" href="/assets/js/28.3c051140.js"><link rel="prefetch" href="/assets/js/29.965e33c4.js"><link rel="prefetch" href="/assets/js/30.5597d20e.js"><link rel="prefetch" href="/assets/js/31.33b4e3cc.js"><link rel="prefetch" href="/assets/js/32.ea642099.js"><link rel="prefetch" href="/assets/js/33.946f15c2.js"><link rel="prefetch" href="/assets/js/34.d8bbaa89.js"><link rel="prefetch" href="/assets/js/35.fc278665.js"><link rel="prefetch" href="/assets/js/36.3e6136c3.js"><link rel="prefetch" href="/assets/js/37.40891321.js"><link rel="prefetch" href="/assets/js/38.6acf3457.js"><link rel="prefetch" href="/assets/js/39.5c089959.js"><link rel="prefetch" href="/assets/js/4.56b57a79.js"><link rel="prefetch" href="/assets/js/40.428fc145.js"><link rel="prefetch" href="/assets/js/41.ed41f981.js"><link rel="prefetch" href="/assets/js/42.f7445bc3.js"><link rel="prefetch" href="/assets/js/43.607ddd9a.js"><link rel="prefetch" href="/assets/js/44.894e15a8.js"><link rel="prefetch" href="/assets/js/45.d3239260.js"><link rel="prefetch" href="/assets/js/46.883deb0d.js"><link rel="prefetch" href="/assets/js/47.a054dba8.js"><link rel="prefetch" href="/assets/js/48.c08e7b16.js"><link rel="prefetch" href="/assets/js/49.6f6f7cda.js"><link rel="prefetch" href="/assets/js/5.8543a414.js"><link rel="prefetch" href="/assets/js/50.07db6097.js"><link rel="prefetch" href="/assets/js/51.f94b91fa.js"><link rel="prefetch" href="/assets/js/52.189a4bf3.js"><link rel="prefetch" href="/assets/js/53.74eca033.js"><link rel="prefetch" href="/assets/js/54.0a1ce0cf.js"><link rel="prefetch" href="/assets/js/55.e0545baa.js"><link rel="prefetch" href="/assets/js/56.30738f9f.js"><link rel="prefetch" href="/assets/js/57.d81ec676.js"><link rel="prefetch" href="/assets/js/58.4c77e767.js"><link rel="prefetch" href="/assets/js/59.3f1a72f1.js"><link rel="prefetch" href="/assets/js/6.dff64863.js"><link rel="prefetch" href="/assets/js/60.12ae3126.js"><link rel="prefetch" href="/assets/js/62.26f4553b.js"><link rel="prefetch" href="/assets/js/63.3e33a68a.js"><link rel="prefetch" href="/assets/js/64.f00cb967.js"><link rel="prefetch" href="/assets/js/65.9cd4dfbe.js"><link rel="prefetch" href="/assets/js/66.a8b2b66e.js"><link rel="prefetch" href="/assets/js/67.040280df.js"><link rel="prefetch" href="/assets/js/68.7d6decd8.js"><link rel="prefetch" href="/assets/js/69.fe435231.js"><link rel="prefetch" href="/assets/js/7.4909d64e.js"><link rel="prefetch" href="/assets/js/70.c0c10666.js"><link rel="prefetch" href="/assets/js/71.103144b8.js"><link rel="prefetch" href="/assets/js/72.d2f4a1f3.js"><link rel="prefetch" href="/assets/js/73.fdf64c02.js"><link rel="prefetch" href="/assets/js/74.ca1ec6f1.js"><link rel="prefetch" href="/assets/js/75.3d51673d.js"><link rel="prefetch" href="/assets/js/76.dff5f2eb.js"><link rel="prefetch" href="/assets/js/77.393e0f8a.js"><link rel="prefetch" href="/assets/js/78.cfc4e5c6.js"><link rel="prefetch" href="/assets/js/79.61b59b3a.js"><link rel="prefetch" href="/assets/js/8.822440c2.js"><link rel="prefetch" href="/assets/js/80.157cea32.js"><link rel="prefetch" href="/assets/js/81.208ca1eb.js"><link rel="prefetch" href="/assets/js/82.e9011406.js"><link rel="prefetch" href="/assets/js/9.63d821ea.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.62a8c583.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d75de8d6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Datopian Tech</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Features" class="dropdown-title"><span class="title">Features</span> <span class="arrow down"></span></button> <button type="button" aria-label="Features" class="mobile-dropdown-title"><span class="title">Features</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/views/" class="nav-link">
  Views
</a></li></ul></div></div> <a href="https://github.com/datopian/tech.datopian.com" target="_blank" rel="noopener noreferrer" class="repo-link">
    Contribute!
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Features" class="dropdown-title"><span class="title">Features</span> <span class="arrow down"></span></button> <button type="button" aria-label="Features" class="mobile-dropdown-title"><span class="title">Features</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/views/" class="nav-link">
  Views
</a></li></ul></div></div> <a href="https://github.com/datopian/tech.datopian.com" target="_blank" rel="noopener noreferrer" class="repo-link">
    Contribute!
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Harvesting</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/harvesting/#introduction" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/harvesting/#features" class="sidebar-link">Features</a></li><li class="sidebar-sub-header"><a href="/harvesting/#harvesting-is-etl" class="sidebar-link">Harvesting is ETL</a></li><li class="sidebar-sub-header"><a href="/harvesting/#domain-model" class="sidebar-link">Domain Model</a></li><li class="sidebar-sub-header"><a href="/harvesting/#components" class="sidebar-link">Components</a></li></ul></li><li><a href="/harvesting/#ckan-v2" class="sidebar-link">CKAN v2</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/harvesting/#limitations" class="sidebar-link">Limitations</a></li></ul></li><li><a href="/harvesting/#ckan-v3" class="sidebar-link">CKAN v3</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/harvesting/#features-2" class="sidebar-link">Features</a></li><li class="sidebar-sub-header"><a href="/harvesting/#design" class="sidebar-link">Design</a></li><li class="sidebar-sub-header"><a href="/harvesting/#user-journey" class="sidebar-link">User Journey</a></li><li class="sidebar-sub-header"><a href="/harvesting/#pipelines" class="sidebar-link">Pipelines</a></li><li class="sidebar-sub-header"><a href="/harvesting/#runner" class="sidebar-link">Runner</a></li><li class="sidebar-sub-header"><a href="/harvesting/#source-spec" class="sidebar-link">Source Spec</a></li><li class="sidebar-sub-header"><a href="/harvesting/#ui" class="sidebar-link">UI</a></li><li class="sidebar-sub-header"><a href="/harvesting/#installation" class="sidebar-link">Installation</a></li><li class="sidebar-sub-header"><a href="/harvesting/#run-it-standalone" class="sidebar-link">Run it standalone</a></li><li class="sidebar-sub-header"><a href="/harvesting/#how-to-integrate-with-ckan-classic" class="sidebar-link">How to integrate with CKAN Classic</a></li><li class="sidebar-sub-header"><a href="/harvesting/#how-do-i" class="sidebar-link">How do I ...</a></li></ul></li><li><a href="/harvesting/#appendix-ckan-classic-harvesting-in-detail" class="sidebar-link">Appendix: CKAN Classic Harvesting in Detail</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/harvesting/#key-aspects" class="sidebar-link">Key Aspects</a></li><li class="sidebar-sub-header"><a href="/harvesting/#domain-model-2" class="sidebar-link">Domain model</a></li><li class="sidebar-sub-header"><a href="/harvesting/#key-components" class="sidebar-link">Key components</a></li><li class="sidebar-sub-header"><a href="/harvesting/#flow" class="sidebar-link">Flow</a></li><li class="sidebar-sub-header"><a href="/harvesting/#ui-2" class="sidebar-link">UI</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="harvesting"><a href="#harvesting" class="header-anchor">#</a> Harvesting</h1> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>Harvesting is the automated collection into a Data Portal of metadata (and maybe data) from other catalogs and sources.</p> <p>The core epic is: As a Data Portal Manager I want to harvest datasets’ metadata (and maybe data) from other portals into my portal so that all the metadata is in one place and hence searchable/discoverable there</p> <h3 id="features"><a href="#features" class="header-anchor">#</a> Features</h3> <p>Key features include:</p> <ul><li>Harvest from multiple sources and with a variety of source metadata formats (e.g. data.json, DCAT, CKAN etc).
<ul><li>Implied is the ability to create and maintain (generic) harvesters for different types of metadata (e.g. data.json, DCAT) (below we call these pipelines)</li> <li>Off-the-shelf harvesting for common metadata formats e.g. data.json, DCAT etc</li></ul></li> <li>Incremental, efficient harvesting from a given source. For example, imagine a source catalog that has ~100k datasets and adds 100 new datasets every day. Assuming you have already harvested this catalog, you only want to harvest those 100 new datasets during your daily harvest (and not re-harvest all 100k). Similarly, you want to be able to handle deletions and modifications of existing datasets.
<ul><li>And even more complex case is where the harvested metadata is edited in the harvesting catalog and one has to handle merging of changes from the source catalog into the harvesting catalog (i.e. you can handle changes in both locations).</li></ul></li> <li>Create and update harvest sources via API and UI</li> <li>Run and view harvests via API (and UI) and the background logging and monitoring to support that</li> <li>Detailed and useful feedback of harvesting errors so that harvest maintainers (or downstream catalog maintainers) can quickly and easily diagnose and fix issues</li> <li>Robust and reliable performance, for example supporting harvesting thousands or even millions of datasets a day</li></ul> <h3 id="harvesting-is-etl"><a href="#harvesting-is-etl" class="header-anchor">#</a> Harvesting is ETL</h3> <p>“Harvesting” of metadata in its essence is exactly the same as any data collection and transformation process (“ETL”). “Metadata” is no different from any other data for our purposes (it is just quite small!).</p> <p>This insight allows us to see harvesting as just like any other ETL process. At the same time, the specific nature of <em>this</em> ETL process e.g. that it is about collecting dataset metadata, allows us to design the system in specific ways.</p> <p>We can use standard ETL tools to do harvesting, loosely coupling their operation to the CKAN Classic (or CKAN Next Gen) metastore.</p> <h3 id="domain-model"><a href="#domain-model" class="header-anchor">#</a> Domain Model</h3> <p>The Harvesting Domain Model has the following conceptual components:</p> <ul><li><strong>Pipeline</strong>: a generic “harvester” pipeline for harvesting a particular data type e.g. data.json, dcat. A pipeline consists of Processors.</li> <li><strong>Source (aka Harvester)</strong>: the entire spec of a repeatable harvest from a given source including the pipeline to use, the source info and any additional configuration e.g. the schedule on which to run this</li> <li><strong>Run (Job)</strong>: a given run of a Source</li> <li><strong>Dataset</strong>: a resulting dataset.</li> <li><strong>Log (Entry)</strong>: (including errors)</li></ul> <p>NB: the term harvester is often used both for a pipeline (e.g. the DCAT Harvester) and for a Source e.g. “XYZ Agency data.json Harvester”. Because of this confusion we prefer to avoid the term, or to reserve it for an active Source e.g. “the GSA data.json harvester”.</p> <h3 id="components"><a href="#components" class="header-anchor">#</a> Components</h3> <p>A Harvesting system has the following key subsystems and components:</p> <h4 id="etl"><a href="#etl" class="header-anchor">#</a> ETL</h4> <ul><li><strong>Pipelines</strong>: a standard way of creating pipelines and processors in code</li> <li><strong>Runner</strong>: a system for executing Runs of the harvesters. This should be queue based.</li> <li><strong>Logging</strong>: a system for logging (and reporting) including of errors</li> <li><strong>Scratch (Store)</strong>: Intermediate storage for temporary or partial outputs of the</li> <li><strong>API</strong>: interfaces the runner and errors</li></ul> <h4 id="sources-and-configuration"><a href="#sources-and-configuration" class="header-anchor">#</a> Sources and Configuration</h4> <ul><li><strong>Source Store</strong>: database of Sources</li> <li><strong>API/UI</strong>: UI, API and CLI usually covering Source Store plus reporting on them e.g. Runs, Errors etc</li></ul> <h4 id="ui-web-command-line-etc"><a href="#ui-web-command-line-etc" class="header-anchor">#</a> UI (web, command line etc)</h4> <ul><li>User interface (web and/or command line etc) to ETL e.g. runner, errors</li> <li>User interface to sources and configuration</li></ul> <h4 id="metastore"><a href="#metastore" class="header-anchor">#</a> MetaStore</h4> <ul><li><strong>MetaStore</strong>: the store for harvested metadata – this is considered to be outside the harvesting system itself</li></ul> <h2 id="ckan-v2"><a href="#ckan-v2" class="header-anchor">#</a> CKAN v2</h2> <p>CKAN v2 implements harvesting via <a href="https://github.com/ckan/ckanext-harvest" target="_blank" rel="noopener noreferrer">ckanext-harvest extension<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>This extension stores configuration in the main DB and harvesters run off a queue process. A detailed analysis of how it works is in <a href="#appendix-ckan-classic-harvesting-in-detail">the appendix below</a>.</p> <h3 id="limitations"><a href="#limitations" class="header-anchor">#</a> Limitations</h3> <p>The main problem is that ckanext-harvest builds its own bespoke mini-ETL system and builds this into CKAN. A bespoke system is less powerful and flexible, harder to maintain etc and building it in makes CKAN more bulky (conceptually, resource wise etc) and creates unnecessary coupling.</p> <p>Good: Using CKAN as config store and having a UI for that</p> <p>Not so good:</p> <ul><li>An ETL system integrated with CKAN
<ul><li>Tightly coupled: so running tests of ETL requires CKAN. This makes it harder to creaate tests (with the result that many harvests have few or no tests).</li> <li>Installation is painful (CKAN + 6 steps) making it harder to use, maintain and contribute to</li> <li>Dependent on CKAN upgrade cycles (tied via code rather than service API)</li> <li>CKAN is more complex</li></ul></li> <li>Bespoke ETL system is both less powerful and harder to maintain
<ul><li>For example, the Runner is bespoke to CKAN rather than using something standard like e.g. Airflow</li> <li>Rigid structure (gather, fetch, import) which may not fit many situations e.g. data.json harvesting (one big file with many datasets where everything done in gather) or where dependencies between stages</li></ul></li> <li>Logging and reporting is not great and hard to customize (logs into CKAN)</li> <li>Maintenance Status - Some maintenance but not super it looks like but quite a lot outstanding (as of Aug 2019):
<ul><li>47 <a href="https://github.com/ckan/ckanext-harvest/issues" target="_blank" rel="noopener noreferrer">open issues<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>6 <a href="https://github.com/ckan/ckanext-harvest/pulls" target="_blank" rel="noopener noreferrer">open pull requests<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (some over a year old)</li></ul></li></ul> <h2 id="ckan-v3"><a href="#ckan-v3" class="header-anchor">#</a> CKAN v3</h2> <p>Next Gen harvesting decouples the core “ETL” part of harvesting into a small, self-contained microservice that is runnable on its own and communicates with the rest of CKAN over APIs. This is consistent with the general <a href="/next-gen/">next gen microservice approach</a>.</p> <p>The design allows the Next Gen Harvester to be used with both CKAN Classic and CKAN Next Gen.</p> <p>Perhaps most important of all, the core harvester can use standard third-party patterns and tools to make it both more powerful, easier to maintain and easier to use. For example, it can use Airflow for its runner rather than a bespoke system built into CKAN.</p> <h3 id="features-2"><a href="#features-2" class="header-anchor">#</a> Features</h3> <p>Specific aspects of the next gen approach:</p> <ul><li>Simple: Easy to write harvesters – just a python script and you can create harvesters without needing to know almost anything about CKAN</li> <li>Runnable and testable standalone (without the rest of CKAN) which makes running and testing much easier</li> <li>Uses the latest standard ETL techniques and technologies</li> <li>Multi-cluster support: run one harvester for multiple CKAN instances</li> <li>Data Package based</li></ul> <h3 id="design"><a href="#design" class="header-anchor">#</a> Design</h3> <p>Here is an overview of the design. Further details on specific parts e.g. Pipelines in following sections. Coloring indicates implementation status:</p> <ul><li>Green: Implemented</li> <li>Pink: In progress</li> <li>Grey: Next up</li></ul> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><h3 id="user-journey"><a href="#user-journey" class="header-anchor">#</a> User Journey</h3> <ul><li>Harvest Curator goes to WUI for Sources and does Create Harvest Source …</li> <li>Fills it in …</li> <li>Comes back to the harvest source dashboard</li> <li>To run a harvest source you go to the new Run UI interface
<ul><li>It lists all harvest sources like the harvest source …</li></ul></li> <li>Click on Run (even if this is just to set up the schedule …)</li> <li>Go to Job page for this run which shows the status of this run and any results …</li> <li>[TODO: how do we link up harvest sources to runs]</li></ul> <h3 id="pipelines"><a href="#pipelines" class="header-anchor">#</a> Pipelines</h3> <p>These follow a standard pattern:</p> <ul><li>Built in Python</li> <li>Use DataFlows by default as way to structure the pipeline (but you can use anything)</li> <li>Produce data packages at each step</li> <li>Pipelines should be divided into two parts:
<ul><li>Extract and Transform: (fetch and convert) fetching remote datasets and converting them into a standard intermediate form (Data Packages)</li> <li>Load: loading that intermediate form into the CKAN instance. This includes not only the format conversion but the work to synchronize state i.e. to create, update or delete in CKAN based on whether a given dataset from the source already has a representation in CKAN (harvests run repeatedly).</li></ul></li></ul> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>This pattern has these benefits:</p> <ul><li>Load functionality to be reused across Harvest Pipelines (the same Load functionality can be used again and again)</li> <li>Cleaner testing: you can test extract and load without needing to have a CKAN instance</li> <li>Ability to reuse Data Package tooling</li></ul> <h4 id="pipeline-example-fetch-and-process-a-data-json"><a href="#pipeline-example-fetch-and-process-a-data-json" class="header-anchor">#</a> Pipeline Example: Fetch and process a data.json</h4> <ul><li><strong>Extract</strong>: Take say a data.json
<ul><li>Validate</li></ul></li> <li><strong>Transform</strong>: Split into datasets and then transform into data packages
<ul><li>Save to local</li></ul></li> <li><strong>Transform 2</strong> check the difference and write to the existing DB.</li> <li><strong>Load</strong>: Write to DB (CKAN metastore / DB)</li></ul> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><h4 id="pipeline-example-detailed"><a href="#pipeline-example-detailed" class="header-anchor">#</a> Pipeline example detailed</h4> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><h3 id="runner"><a href="#runner" class="header-anchor">#</a> Runner</h3> <p>We use Apache Airflow for the Runner.</p> <h3 id="source-spec"><a href="#source-spec" class="header-anchor">#</a> Source Spec</h3> <p>This the specification of the Source object</p> <p>You can compare this to <a href="#harvest-source-objects">CKAN Classic HarvestSource objects below</a>.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>id<span class="token operator">:</span>
url<span class="token operator">:</span>
title<span class="token operator">:</span>
description<span class="token operator">:</span>
created<span class="token operator">:</span>
harvester_pipeline_id<span class="token operator">:</span> <span class="token comment">// type in old CKAN</span>
config<span class="token operator">:</span>
enabled<span class="token operator">:</span>              <span class="token comment">// is this harvester enabled at the moment</span>
owner<span class="token operator">:</span> <span class="token comment">// user_id</span>
publisher_id<span class="token operator">:</span> <span class="token comment">// what is this?? Maybe the org the dataset is attached to ...</span>
frequency<span class="token operator">:</span>  <span class="token comment">// MANUAL, DAILY etc</span>
</code></pre></div><h3 id="ui"><a href="#ui" class="header-anchor">#</a> UI</h3> <ul><li>Jobs UI: moves to next gen</li> <li>Source UI: stays in classic for now …</li></ul> <h3 id="installation"><a href="#installation" class="header-anchor">#</a> Installation</h3> <p>CKAN Next Gen is in active development and is being deployed in production.</p> <p>You can find the code here:</p> <p><a href="https://gitlab.com/datopian/ckan-ng-harvester-core" target="_blank" rel="noopener noreferrer">https://gitlab.com/datopian/ckan-ng-harvester-core<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="run-it-standalone"><a href="#run-it-standalone" class="header-anchor">#</a> Run it standalone</h3> <p>TODO</p> <h3 id="how-to-integrate-with-ckan-classic"><a href="#how-to-integrate-with-ckan-classic" class="header-anchor">#</a> How to integrate with CKAN Classic</h3> <p>Config in CKAN MetaStore, ETL in new System</p> <ul><li>Keep storage and config in CKAN MetaStore (e.g. CKAN Classic)</li> <li>New ETL system for the actual harvesting process</li></ul> <p><strong>Pulling Config</strong></p> <ul><li>Define a spec format for sources</li> <li>Script to convert this to Airflow DAGs</li> <li>Script to convert CKAN Harvest sources into the spec and hence into Airflow DAGs</li></ul> <p><strong>Showing Status and Errors</strong></p> <ul><li>We create a viewer from Airflow status =&gt; JS SPA</li> <li>and then embed in CKAN Classic Admin UI</li></ul> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>More detailed version:</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><h3 id="how-do-i"><a href="#how-do-i" class="header-anchor">#</a> How do I …</h3> <p>Support parent-child relationships in harvested datasets e.g. in data.json?</p> <p>Enhance / transform incoming datasets e.g. assigning topics based on sources e.g. this is geodata</p> <h2 id="appendix-ckan-classic-harvesting-in-detail"><a href="#appendix-ckan-classic-harvesting-in-detail" class="header-anchor">#</a> Appendix: CKAN Classic Harvesting in Detail</h2> <p><a href="https://github.com/ckan/ckanext-harvest" target="_blank" rel="noopener noreferrer">https://github.com/ckan/ckanext-harvest<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>README is excellent and def worth reading - key parts of that are also below.</p> <h3 id="key-aspects"><a href="#key-aspects" class="header-anchor">#</a> Key Aspects</h3> <ul><li>Redis and AMQP (does anyone use AMQP)</li> <li>Logs to database with API access (off by default) - <a href="https://github.com/ckan/ckanext-harvest#database-logger-configurationoptional" target="_blank" rel="noopener noreferrer">https://github.com/ckan/ckanext-harvest#database-logger-configurationoptional<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Dataset name generation (to avoid overwriting)</li> <li>Send mail when harvesting fails</li> <li>CLI - <a href="https://github.com/ckan/ckanext-harvest#command-line-interface" target="_blank" rel="noopener noreferrer">https://github.com/ckan/ckanext-harvest#command-line-interface<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Authorization - <a href="https://github.com/ckan/ckanext-harvest#authorization" target="_blank" rel="noopener noreferrer">https://github.com/ckan/ckanext-harvest#authorization<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Built in CKAN harvester - <a href="https://github.com/ckan/ckanext-harvest#the-ckan-harvester" target="_blank" rel="noopener noreferrer">https://github.com/ckan/ckanext-harvest#the-ckan-harvester<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Running it: you run the queue listeners (gather )</li></ul> <p>Existing harvesters</p> <ul><li>CKAN - ckanext-harvest</li> <li>DCAT - <a href="https://github.com/ckan/ckanext-dcat/tree/master/ckanext/dcat/harvesters" target="_blank" rel="noopener noreferrer">https://github.com/ckan/ckanext-dcat/tree/master/ckanext/dcat/harvesters<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Spatial - <a href="https://github.com/ckan/ckanext-spatial/tree/master/ckanext/spatial/harvesters" target="_blank" rel="noopener noreferrer">https://github.com/ckan/ckanext-spatial/tree/master/ckanext/spatial/harvesters<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="domain-model-2"><a href="#domain-model-2" class="header-anchor">#</a> Domain model</h3> <p>See <a href="https://github.com/ckan/ckanext-harvest/blob/master/ckanext/harvest/model/__init__.py" target="_blank" rel="noopener noreferrer">https://github.com/ckan/ckanext-harvest/blob/master/ckanext/harvest/model/__init__.py<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>HarvestSource - a remote source for harvesting datasets from e.g. a CSW server or CKAN instance</li> <li>HarvestJob - a job to do the harvesting (done in 2 stages: gather and then fetch and import). This is basically state for the overall process of doing a harvest.</li> <li>HarvestObject - job to harvest one dataset. Also holds dataset on the remote instance (id / url)</li> <li>HarvestGatherError</li> <li>HarvestObjectError</li> <li>HarvestLog</li></ul> <h4 id="harvest-source-objects"><a href="#harvest-source-objects" class="header-anchor">#</a> Harvest Source Objects</h4> <p><a href="https://github.com/ckan/ckanext-harvest/blob/master/ckanext/harvest/model/__init__.py#L230-L245" target="_blank" rel="noopener noreferrer">https://github.com/ckan/ckanext-harvest/blob/master/ckanext/harvest/model/__init__.py#L230-L245<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># harvest_source_table</span>
Column<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> default<span class="token operator">=</span>make_uuid<span class="token punctuation">)</span><span class="token punctuation">,</span>
Column<span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
Column<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">u''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
Column<span class="token punctuation">(</span><span class="token string">'description'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">u''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
Column<span class="token punctuation">(</span><span class="token string">'config'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">u''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
Column<span class="token punctuation">(</span><span class="token string">'created'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>DateTime<span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">)</span><span class="token punctuation">,</span>
Column<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
Column<span class="token punctuation">(</span><span class="token string">'active'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
Column<span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">u''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
Column<span class="token punctuation">(</span><span class="token string">'publisher_id'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">u''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
Column<span class="token punctuation">(</span><span class="token string">'frequency'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">u'MANUAL'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
Column<span class="token punctuation">(</span><span class="token string">'next_run'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>DateTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># not needed</span>
</code></pre></div><h4 id="harvest-error-and-log-objects"><a href="#harvest-error-and-log-objects" class="header-anchor">#</a> Harvest Error and Log Objects</h4> <p><a href="https://github.com/ckan/ckanext-harvest/blob/master/ckanext/harvest/model/__init__.py#L303-L331" target="_blank" rel="noopener noreferrer">https://github.com/ckan/ckanext-harvest/blob/master/ckanext/harvest/model/__init__.py#L303-L331<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># New table</span>
harvest_gather_error_table <span class="token operator">=</span> Table<span class="token punctuation">(</span>
    <span class="token string">'harvest_gather_error'</span><span class="token punctuation">,</span>
    metadata<span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> default<span class="token operator">=</span>make_uuid<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">'harvest_job_id'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'harvest_job.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">'created'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>DateTime<span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token comment"># New table</span>
harvest_object_error_table <span class="token operator">=</span> Table<span class="token punctuation">(</span>
    <span class="token string">'harvest_object_error'</span><span class="token punctuation">,</span>
    metadata<span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> default<span class="token operator">=</span>make_uuid<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">'harvest_object_id'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'harvest_object.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">'stage'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">'line'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>Integer<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">'created'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>DateTime<span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token comment"># Harvest Log table</span>
harvest_log_table <span class="token operator">=</span> Table<span class="token punctuation">(</span>
    <span class="token string">'harvest_log'</span><span class="token punctuation">,</span>
    metadata<span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> default<span class="token operator">=</span>make_uuid<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>UnicodeText<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">'level'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>Enum<span class="token punctuation">(</span><span class="token string">'DEBUG'</span><span class="token punctuation">,</span> <span class="token string">'INFO'</span><span class="token punctuation">,</span> <span class="token string">'WARNING'</span><span class="token punctuation">,</span> <span class="token string">'ERROR'</span><span class="token punctuation">,</span> <span class="token string">'CRITICAL'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'log_level'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Column<span class="token punctuation">(</span><span class="token string">'created'</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>DateTime<span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="key-components"><a href="#key-components" class="header-anchor">#</a> Key components</h3> <ul><li>Configuration: HarvestSource objects</li> <li>Pipelines: Gather, Fetch, Import stages in a given harvest extension</li> <li>Runner: bespoke queue system (backed by Redis or AMQP). Scheduler is external e.g. Cron</li> <li>Logging: logged into CKAN DB (as Harvest Errors)</li> <li>Interface: API, Web UI and CLI</li> <li>Storage:
<ul><li>Final: Datasets are in CKAN MetaStore</li> <li>Intermediate: HarvestObject in CKAN MetaStore</li></ul></li></ul> <h3 id="flow"><a href="#flow" class="header-anchor">#</a> Flow</h3> <ol start="0"><li><em>Harvest run:</em> a regular run of the Harvester that generates a HarvestJob object. This is then passed to gather stage. This is what is generated by cron <code>harvest run</code> execution (or from web UI)</li> <li>The <strong>gather</strong> stage compiles all the resource identifiers that need to be fetched in the next stage (e.g. in a CSW server, it will perform a GetRecords operation).</li> <li>The <strong>fetch</strong> stage gets the contents of the remote objects and stores them in the database (e.g. in a CSW server, it will perform an GetRecordById operations).</li> <li>The <strong>import</strong> stage performs any necessary actions on the fetched resource (generally creating a CKAN package, but it can be anything the extension needs).</li></ol> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">gather_stage</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> harvest_job<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    The gather stage will receive a HarvestJob object and will be
    responsible for:
        - gathering all the necessary objects to fetch on a later.
          stage (e.g. for a CSW server, perform a GetRecords request)
        - creating the necessary HarvestObjects in the database, specifying
          the guid and a reference to its job. The HarvestObjects need a
          reference date with the last modified date for the resource, this
          may need to be set in a different stage depending on the type of
          source.
        - creating and storing any suitable HarvestGatherErrors that may
          occur.
        - returning a list with all the ids of the created HarvestObjects.
        - to abort the harvest, create a HarvestGatherError and raise an
          exception. Any created HarvestObjects will be deleted.

    :param harvest_job: HarvestJob object
    :returns: A list of HarvestObject ids
    '''</span>

<span class="token keyword">def</span> <span class="token function">fetch_stage</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> harvest_object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    The fetch stage will receive a HarvestObject object and will be
    responsible for:
        - getting the contents of the remote object (e.g. for a CSW server,
          perform a GetRecordById request).
        - saving the content in the provided HarvestObject.
        - creating and storing any suitable HarvestObjectErrors that may
          occur.
        - returning True if everything is ok (ie the object should now be
          imported), &quot;unchanged&quot; if the object didn't need harvesting after
          all (ie no error, but don't continue to import stage) or False if
          there were errors.

    :param harvest_object: HarvestObject object
    :returns: True if successful, 'unchanged' if nothing to import after
              all, False if not successful
    '''</span>

<span class="token keyword">def</span> <span class="token function">import_stage</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> harvest_object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    The import stage will receive a HarvestObject object and will be
    responsible for:
        - performing any necessary action with the fetched object (e.g.
          create, update or delete a CKAN package).
          Note: if this stage creates or updates a package, a reference
          to the package should be added to the HarvestObject.
        - setting the HarvestObject.package (if there is one)
        - setting the HarvestObject.current for this harvest:
           - True if successfully created/updated
           - False if successfully deleted
        - setting HarvestObject.current to False for previous harvest
          objects of this harvest source if the action was successful.
        - creating and storing any suitable HarvestObjectErrors that may
          occur.
        - creating the HarvestObject - Package relation (if necessary)
        - returning True if the action was done, &quot;unchanged&quot; if the object
          didn't need harvesting after all or False if there were errors.

    NB You can run this stage repeatedly using 'paster harvest import'.

    :param harvest_object: HarvestObject object
    :returns: True if the action was done, &quot;unchanged&quot; if the object didn't
              need harvesting after all or False if there were errors.
    '''</span>
</code></pre></div><h3 id="ui-2"><a href="#ui-2" class="header-anchor">#</a> UI</h3> <p>Harvest admin portal</p> <p><img src="https://i.imgur.com/Y0cyrUG.png" alt=""></p> <p>Add a Harvest Source</p> <p><img src="https://i.imgur.com/uoBFAjY.png" alt=""></p> <p>Clicking on Harvest Source gives you list of datasets harvested</p> <p><img src="https://i.imgur.com/hIRrDHP.png" alt=""></p> <p>Clicking on about gives you…</p> <p><img src="https://i.imgur.com/S9GTl9n.png" alt=""></p> <p>Admin view of a particular (Harvest) source</p> <p><img src="https://i.imgur.com/Loeshhv.png" alt=""></p> <p>Edit harvester</p> <p><img src="https://i.imgur.com/3SOuCm5.png" alt=""></p> <p>Jobs summary</p> <p><img src="https://i.imgur.com/QwD7nHi.png" alt=""></p> <p>Individual jobs</p> <p><img src="https://i.imgur.com/ljKEk0l.png" alt=""></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/datopian/tech.datopian.com/edit/master/harvesting/README.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Modified:</span> <span class="time">11/5/2020, 9:56:09 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.90a758e8.js" defer></script><script src="/assets/js/3.fa4bc789.js" defer></script><script src="/assets/js/61.ce00e677.js" defer></script>
  </body>
</html>
